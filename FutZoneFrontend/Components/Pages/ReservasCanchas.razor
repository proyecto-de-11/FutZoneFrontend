@page "/reservas-canchas"
@using System.Collections.Generic
@using FutZoneFrontend.Services
@using FutZoneFrontend.Services.Models
@inject ICanchasService CanchasService
@inject IReservasService ReservasService

<style>
    body { background: linear-gradient(120deg,#186c4a 80%,#f7f6ec); }
    .reserva-header {
        background: #21a17b;
        color: #fff;
        border-radius: 1.2em;
        box-shadow: 0 3px 12px -4px #073830;
        margin-bottom:2em; 
        padding:1.2em;
    }
    .card-reserva { border-left:8px solid #199467; border-radius:1em;}
    .form-label { font-weight: 600; }
    .badge.bg-success, .badge.bg-secondary { font-size:.98em; }
</style>

<div class="container py-4">
  <div class="reserva-header text-center mb-4">
    <h2><i class="bi bi-calendar-event"></i> Reservas de Canchas</h2>
    <small>Agenda tu partido fácilmente</small>
  </div>

  <!-- Alerta de Error -->
  @if (!string.IsNullOrEmpty(ErrorMessage))
  {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="bi bi-exclamation-triangle-fill"></i>
      <strong>Error:</strong> @ErrorMessage
      <button type="button" class="btn-close" @onclick="() => ErrorMessage = null"></button>
    </div>
  }

  <!-- Estado de Cargando -->
  @if (IsLoading)
  {
    <div class="alert alert-info" role="alert">
      <div class="spinner-border spinner-border-sm" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <strong>Cargando canchas disponibles...</strong>
    </div>
  }

  <!-- Alerta de Éxito -->
  @if (!string.IsNullOrEmpty(SuccessMessage))
  {
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="bi bi-check-circle-fill"></i>
      <strong>Éxito:</strong> @SuccessMessage
      <button type="button" class="btn-close" @onclick="() => SuccessMessage = null"></button>
    </div>
  }

  <div class="card card-reserva shadow mb-3">
    <div class="card-header bg-dark text-white">
      <i class="bi bi-check-circle"></i> Reserva tu cancha
    </div>
    <div class="card-body">
      <form @onsubmit="HandleReserva">
        <div class="row mb-3">
          <div class="col-lg-6 mb-2">
            <label class="form-label">Cancha</label>
            <select class="form-select" @bind="SelectedCancha" required>
              <option value="">-- Selecciona una cancha --</option>
              @foreach (var cancha in Canchas)
              {
                <option value="@cancha.Id">@cancha.Nombre (@cancha.Tipo)</option>
              }
            </select>
          </div>
          <div class="col-lg-6 mb-2">
            <label class="form-label">Fecha y hora</label>
            <input type="datetime-local" class="form-control" @bind="FechaHoraObj" required>
          </div>
        </div>
        <button type="submit" class="btn btn-success">
          <i class="bi bi-calendar-plus"></i> Reservar ahora
        </button>
      </form>
    </div>
    <div class="card-footer text-muted">
      <i class="bi bi-info-circle"></i> Recuerda llegar 10 minutos antes de tu hora reservada.
    </div>
  </div>

  <!-- Histórico / próximas reservas -->
  <div class="card shadow">
    <div class="card-header bg-info text-dark">
      <i class="bi bi-clock-history"></i> Próximas reservas
    </div>
    @if (ProximasReservas.Count > 0)
    {
      <ul class="list-group list-group-flush">
        @foreach (var reserva in ProximasReservas)
        {
          <li class="list-group-item d-flex justify-content-between align-items-center">
            @reserva.NombreCancha - @reserva.Fecha @reserva.Hora hs
            <span class="badge bg-@(reserva.Estado == "Confirmada" ? "success" : "secondary")">@reserva.Estado</span>
          </li>
        }
      </ul>
    }
    else
    {
      <div class="card-body text-center text-muted">
        <i class="bi bi-inbox"></i> No tienes reservas próximas
      </div>
    }
  </div>
</div>

@code {
    private class CanchaModel
    {
        public int Id { get; set; }
        public string Nombre { get; set; } = string.Empty;
        public string Tipo { get; set; } = string.Empty;
    }

    private class ReservaModel
    {
        public int Id { get; set; }
        public string NombreCancha { get; set; } = string.Empty;
        public string Fecha { get; set; } = string.Empty;
        public string Hora { get; set; } = string.Empty;
        public string Estado { get; set; } = string.Empty;
    }

    private List<CanchaModel> Canchas = new();
    private List<ReservaModel> ProximasReservas = new();

    private string SelectedCancha = "";
    private DateTime? FechaHoraObj = null;
    private bool IsLoading = true;
    private string ErrorMessage = string.Empty;
    private string SuccessMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            IsLoading = true;
            await CargarCanchas();
            await CargarProximasReservas();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error al cargar: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task CargarCanchas()
    {
        try
        {
            var canchasResult = await CanchasService.GetAllCanchasAsync();
            if (canchasResult != null && canchasResult.Count > 0)
            {
                Canchas = canchasResult
                    .Select(c => new CanchaModel
                    {
                        Id = c.Id,
                        Nombre = c.Nombre,
                        Tipo = c.TipoSuperficie ?? "Desconocido"
                    })
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error cargando canchas: {ex.Message}";
        }
    }

    private async Task CargarProximasReservas()
    {
        try
        {
            var reservasResult = await ReservasService.GetAllReservasAsync();
            if (reservasResult != null && reservasResult.Count > 0)
            {
                ProximasReservas = reservasResult
                    .Where(r => r.FechaInicio.HasValue && r.FechaInicio > DateTime.Now)
                    .OrderBy(r => r.FechaInicio)
                    .Take(10)
                    .Select(r => new ReservaModel
                    {
                        Id = r.Id,
                        NombreCancha = $"Cancha {r.CanchaId}",
                        Fecha = r.FechaInicio?.ToString("dd/MM") ?? "N/A",
                        Hora = r.FechaInicio?.ToString("HH:mm") ?? "N/A",
                        Estado = r.Estado ?? "Pendiente"
                    })
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error cargando reservas: {ex.Message}";
        }
    }

    private async Task HandleReserva()
    {
        if (string.IsNullOrEmpty(SelectedCancha) || !FechaHoraObj.HasValue)
        {
            ErrorMessage = "Por favor, selecciona una cancha y una fecha/hora";
            return;
        }

        try
        {
            var reserva = new CreateReservaDto
            {
                CanchaId = int.Parse(SelectedCancha),
                UsuarioSolicitanteId = 1, // TODO: Obtener del usuario autenticado
                FechaReserva = FechaHoraObj.Value.ToString("yyyy-MM-dd"),
                HoraInicio = FechaHoraObj.Value.ToString("HH:mm:ss"),
                HoraFin = FechaHoraObj.Value.AddHours(1).ToString("HH:mm:ss"),
                DuracionHoras = 1,
                MontoTotal = 50, // TODO: Obtener del precio de la cancha
                MensajeSolicitud = string.Empty
            };

            var resultado = await ReservasService.CreateReservaAsync(reserva);
            if (resultado != null)
            {
                SuccessMessage = $"Reserva creada exitosamente";
                SelectedCancha = "";
                FechaHoraObj = null;
                await CargarProximasReservas();
                StateHasChanged();
            }
            else
            {
                ErrorMessage = "Error al crear la reserva";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error: {ex.Message}";
        }
    }
}
    }
