@page "/reservas-canchas"
@using System.Collections.Generic
@using FutZoneFrontend.Services
@using FutZoneFrontend.Services.Models
@inject ICanchasService CanchasService
@inject IReservasService ReservasService
@inject IAuthService AuthService

<style>
    body { background: linear-gradient(120deg,#186c4a 80%,#f7f6ec); }
    .reserva-header {
        background: #21a17b;
        color: #fff;
        border-radius: 1.2em;
        box-shadow: 0 3px 12px -4px #073830;
        margin-bottom:2em; 
        padding:1.2em;
    }
    .card-reserva { border-left:8px solid #199467; border-radius:1em;}
    .form-label { font-weight: 600; }
    .badge.bg-success, .badge.bg-secondary { font-size:.98em; }
</style>

<div class="container py-4">
  <div class="reserva-header text-center mb-4">
    <h2><i class="bi bi-calendar-event"></i> Reservas de Canchas</h2>
    <small>Agenda tu partido fácilmente</small>
  </div>

  <!-- Alerta de Error -->
  @if (!string.IsNullOrEmpty(ErrorMessage))
  {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="bi bi-exclamation-triangle-fill"></i>
      <strong>Error:</strong> @ErrorMessage
      <button type="button" class="btn-close" @onclick="() => ErrorMessage = null"></button>
    </div>
  }

  <!-- Estado de Cargando -->
  @if (IsLoading)
  {
    <div class="alert alert-info" role="alert">
      <div class="spinner-border spinner-border-sm" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <strong>Cargando canchas disponibles...</strong>
    </div>
  }

  <!-- Alerta de Éxito -->
  @if (!string.IsNullOrEmpty(SuccessMessage))
  {
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="bi bi-check-circle-fill"></i>
      <strong>Éxito:</strong> @SuccessMessage
      <button type="button" class="btn-close" @onclick="() => SuccessMessage = null"></button>
    </div>
  }

    <div class="card card-reserva shadow mb-3">
    <div class="card-header bg-dark text-white">
      <i class="bi bi-check-circle"></i> Reserva tu cancha
    </div>
    <div class="card-body">
      <form @onsubmit="HandleReserva">
        <!-- Cancha -->
        <div class="row mb-3">
          <div class="col-lg-8 mb-2">
            <label class="form-label">Cancha *</label>
            <select class="form-select" @bind="SelectedCancha" required>
              <option value="">-- Selecciona una cancha --</option>
              @foreach (var cancha in Canchas)
              {
                <option value="@cancha.Id">@cancha.Nombre (@cancha.Tipo)</option>
              }
            </select>
          </div>
        </div>

        <!-- Fecha y horas - Usando datetime-local para simplicidad -->
        <div class="row mb-3">
          <div class="col-lg-6 mb-2">
            <label class="form-label">Fecha y hora inicio *</label>
            <input type="datetime-local" class="form-control" @bind="FechaHoraInicio" required>
          </div>
          <div class="col-lg-6 mb-2">
            <label class="form-label">Duración (horas) *</label>
            <input type="number" class="form-control" @bind="DuracionHoras" step="0.5" min="0.5" required>
          </div>
        </div>

        <!-- Monto -->
        <div class="row mb-3">
          <div class="col-lg-6 mb-2">
            <label class="form-label">Monto total ($) *</label>
            <input type="number" class="form-control" @bind="MontoTotal" step="0.01" min="0" required>
          </div>
          <div class="col-lg-6 mb-2">
            <label class="form-label">Equipo (opcional)</label>
            <input type="number" class="form-control" @bind.after="EquipoId" placeholder="ID del equipo">
          </div>
        </div>

        <!-- Mensaje -->
        <div class="mb-3">
          <label class="form-label">Mensaje de solicitud (opcional)</label>
          <textarea class="form-control" @bind="MensajeSolicitud" rows="3" placeholder="Ej: Necesitamos esta cancha para nuestro partido de la liga."></textarea>
        </div>

        <button type="submit" class="btn btn-success" disabled="@IsSubmitting">
          @if (IsSubmitting)
          {
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            <span>Reservando...</span>
          }
          else
          {
            <i class="bi bi-calendar-plus"></i> <span>Reservar ahora</span>
          }
        </button>
      </form>
    </div>
    <div class="card-footer text-muted">
      <i class="bi bi-info-circle"></i> Recuerda llegar 10 minutos antes de tu hora reservada.
    </div>
  </div>  <!-- Histórico / próximas reservas -->
  <div class="card shadow">
    <div class="card-header bg-info text-dark">
      <i class="bi bi-clock-history"></i> Próximas reservas
    </div>
    @if (ProximasReservas.Count > 0)
    {
      <ul class="list-group list-group-flush">
        @foreach (var reserva in ProximasReservas)
        {
          <li class="list-group-item d-flex justify-content-between align-items-center">
            @reserva.NombreCancha - @reserva.Fecha @reserva.Hora hs
            <span class="badge bg-@(reserva.Estado == "Confirmada" ? "success" : "secondary")">@reserva.Estado</span>
          </li>
        }
      </ul>
    }
    else
    {
      <div class="card-body text-center text-muted">
        <i class="bi bi-inbox"></i> No tienes reservas próximas
      </div>
    }
  </div>
</div>

@code {
    private class CanchaModel
    {
        public int Id { get; set; }
        public string Nombre { get; set; } = string.Empty;
        public string Tipo { get; set; } = string.Empty;
    }

    private class ReservaModel
    {
        public int Id { get; set; }
        public string NombreCancha { get; set; } = string.Empty;
        public string Fecha { get; set; } = string.Empty;
        public string Hora { get; set; } = string.Empty;
        public string Estado { get; set; } = string.Empty;
    }

    private List<CanchaModel> Canchas = new();
    private List<ReservaModel> ProximasReservas = new();

    private string SelectedCancha = "";
    private int? EquipoId;
    private DateTime? FechaHoraInicio;
    private decimal DuracionHoras = 1;
    private decimal MontoTotal = 50;
    private string MensajeSolicitud = string.Empty;
    
    private bool IsLoading = true;
    private bool IsSubmitting = false;
    private string ErrorMessage = string.Empty;
    private string SuccessMessage = string.Empty;
    private int UsuarioSolicitanteId = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            IsLoading = true;
            // Obtener ID del usuario autenticado
            UsuarioSolicitanteId = await AuthService.GetUserIdAsync() ?? 0;
            await CargarCanchas();
            await CargarProximasReservas();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error al cargar: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task CargarCanchas()
    {
        try
        {
            var canchasResult = await CanchasService.GetAllCanchasAsync();
            if (canchasResult != null && canchasResult.Count > 0)
            {
                Canchas = canchasResult
                    .Select(c => new CanchaModel
                    {
                        Id = c.Id,
                        Nombre = c.Nombre,
                        Tipo = c.TipoSuperficie ?? "Desconocido"
                    })
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error cargando canchas: {ex.Message}";
        }
    }

    private async Task CargarProximasReservas()
    {
        try
        {
            var reservasResult = await ReservasService.GetAllReservasAsync();
            if (reservasResult != null && reservasResult.Count > 0)
            {
                ProximasReservas = reservasResult
                    .Where(r => r.FechaReserva.HasValue && r.FechaReserva > DateTime.Now)
                    .OrderBy(r => r.FechaReserva)
                    .Take(10)
                    .Select(r => new ReservaModel
                    {
                        Id = r.Id,
                        NombreCancha = $"Cancha {r.CanchaId}",
                        Fecha = r.FechaReserva?.ToString("dd/MM") ?? "N/A",
                        Hora = r.HoraInicio ?? "N/A",
                        Estado = r.Estado ?? "Pendiente"
                    })
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error cargando reservas: {ex.Message}";
        }
    }

    private async Task HandleReserva()
    {
        if (string.IsNullOrEmpty(SelectedCancha) || !FechaHoraInicio.HasValue)
        {
            ErrorMessage = "Por favor, completa los campos obligatorios (cancha, fecha y hora)";
            return;
        }

        try
        {
            IsSubmitting = true;
            ErrorMessage = string.Empty;
            SuccessMessage = string.Empty;

            var fechaHora = FechaHoraInicio.Value;
            var horaFin = fechaHora.AddHours((double)DuracionHoras);

            var reserva = new CreateReservaDto
            {
                CanchaId = int.Parse(SelectedCancha),
                EquipoId = EquipoId,
                UsuarioSolicitanteId = UsuarioSolicitanteId,
                FechaReserva = fechaHora.ToString("yyyy-MM-dd"),
                HoraInicio = fechaHora.ToString("HH:mm:ss"),
                HoraFin = horaFin.ToString("HH:mm:ss"),
                DuracionHoras = DuracionHoras,
                MontoTotal = MontoTotal,
                MensajeSolicitud = MensajeSolicitud
            };

            Console.WriteLine($"[ReservasCanchas] Enviando reserva: Cancha={reserva.CanchaId}, Usuario={reserva.UsuarioSolicitanteId}, Fecha={reserva.FechaReserva}, HoraInicio={reserva.HoraInicio}, Duracion={reserva.DuracionHoras}");

            var resultado = await ReservasService.CreateReservaAsync(reserva);
            if (resultado != null)
            {
                SuccessMessage = "¡Reserva creada exitosamente! Espera la confirmación del propietario.";
                // Limpiar formulario
                SelectedCancha = "";
                EquipoId = null;
                FechaHoraInicio = null;
                DuracionHoras = 1;
                MontoTotal = 50;
                MensajeSolicitud = string.Empty;
                await CargarProximasReservas();
                StateHasChanged();
            }
            else
            {
                ErrorMessage = "Error al crear la reserva. Intenta nuevamente.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ReservasCanchas] Error: {ex.Message}");
            Console.WriteLine($"[ReservasCanchas] Stack: {ex.StackTrace}");
            ErrorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            IsSubmitting = false;
        }
    }
}
