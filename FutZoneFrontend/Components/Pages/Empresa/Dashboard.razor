@page "/propietario/dashboard"
@using System.Collections.Generic
@using FutZoneFrontend.Services
@using FutZoneFrontend.Services.Models
@inject ICanchasService CanchasService
@inject IReservasService ReservasService

<PageTitle>Dashboard Propietario - FutZone</PageTitle>

<div class="propietario-dashboard">
    <div class="dashboard-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col">
                    <h1> Dashboard Propietario</h1>
                    <small>Bienvenido a tu centro de control</small>
                </div>
                <div class="col-auto">
                    <div class="header-actions">
                        <a class="btn btn-outline-light" href="/empresa/crear">Crear Empresa</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-content">
        <div class="container-fluid">

            <!-- Estados de Carga -->
            @if (_cargando)
            {
                <div class="alert alert-info d-flex align-items-center" role="alert">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <span>Cargando datos del dashboard...</span>
                </div>
            }

            @if (!string.IsNullOrEmpty(_mensajeError))
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle"></i> <strong>Error:</strong> @_mensajeError
                    <button type="button" class="btn-close" @onclick="() => _mensajeError = string.Empty"></button>
                </div>
            }

            <!-- KPIs Principales -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="kpi-card">
                        <div class="kpi-icon"></div>
                        <div class="kpi-body">
                            <h6>Ingresos Este Mes</h6>
                            <h2>$@_ingresosMes.ToString("F2")</h2>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-3">
                    <div class="kpi-card">
                        <div class="kpi-icon"></div>
                        <div class="kpi-body">
                            <h6>Reservas Pendientes</h6>
                            <h2>@_reservasPendientes</h2>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-3">
                    <div class="kpi-card">
                        <div class="kpi-icon"></div>
                        <div class="kpi-body">
                            <h6>Ocupaci贸n Promedio</h6>
                            <h2>@_ocupacionPromedio%</h2>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-3">
                    <div class="kpi-card">
                        <div class="kpi-icon"></div>
                        <div class="kpi-body">
                            <h6>Clientes Activos</h6>
                            <h2>@_clientesActivos</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mis Canchas -->
            <div class="section-header">
                <h3>Mis Canchas</h3>
                <small class="text-muted">Estado general de tus canchas</small>
            </div>

            <div class="canchas-grid">
                @if (_canchas == null || _canchas.Count == 0)
                {
                    <div class="alert alert-info">No hay canchas registradas.</div>
                }
                else
                {
                    @foreach (var cancha in _canchas)
                    {
                        <div class="cancha-card">
                            <div class="cancha-header">
                                <h5>@cancha.Nombre</h5>
                                <span class="badge @(cancha.Activa ? "bg-success" : "bg-secondary")">@(cancha.Activa ? "Activa" : "Inactiva")</span>
                            </div>
                            <div class="cancha-body">
                                <div class="cancha-stat">
                                    <span class="cancha-stat-label">Hoy</span>
                                    <span class="cancha-stat-value">@_reservasPorCancha.GetValueOrDefault(cancha.Id, 0) reservas</span>
                                </div>
                                <div class="cancha-stat">
                                    <span class="cancha-stat-label">Ocupaci贸n</span>
                                    <span class="cancha-stat-value">@_ocupacionPorCancha.GetValueOrDefault(cancha.Id, 0)%</span>
                                </div>
                                <div class="cancha-stat">
                                    <span class="cancha-stat-label">Tarifa</span>
                                    <span class="cancha-stat-value">$@cancha.PrecioHora/hr</span>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

<style>
    .propietario-dashboard {
        background-color: #f4f7f6;
    }

    .kpi-card {
        background-color: white;
        border-radius: 12px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }

    .kpi-icon {
        font-size: 2.5rem;
    }

    .section-header h3 {
        font-weight: 600;
    }

    .canchas-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
    }

    .cancha-card {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        overflow: hidden;
    }

    .cancha-header {
        padding: 1rem 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #dee2e6;
    }

    .cancha-header h5 {
        margin: 0;
        font-weight: 600;
    }

    .cancha-body {
        padding: 1.25rem;
    }

    .cancha-stat {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .cancha-stat-label {
        color: #6c757d;
    }
</style>

@code {
    private bool _cargando = true;
    private string _mensajeError = string.Empty;
    
    private decimal _ingresosMes = 0;
    private int _reservasPendientes = 0;
    private int _ocupacionPromedio = 0;
    private int _clientesActivos = 0;
    
    private List<Cancha> _canchas = new();
    private List<ReservaDto> _reservas = new();
    private Dictionary<int, int> _reservasPorCancha = new();
    private Dictionary<int, int> _ocupacionPorCancha = new();
    
    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }
    
    private async Task CargarDatos()
    {
        try
        {
            _cargando = true;
            _mensajeError = string.Empty;
            
            // Cargar canchas
            _canchas = await CanchasService.GetAllCanchasAsync() ?? new();
            
            // Cargar reservas
            _reservas = await ReservasService.GetAllReservasAsync() ?? new();
            
            // Calcular m茅tricas
            CalcularMetricas();
        }
        catch (Exception ex)
        {
            _mensajeError = $"Error al cargar datos: {ex.Message}";
        }
        finally
        {
            _cargando = false;
        }
    }
    
    private void CalcularMetricas()
    {
        // Ingresos del mes (suma de precios de reservas confirmadas)
        _ingresosMes = _reservas
            .Where(r => r.Estado?.ToLower() == "confirmada" || r.Estado?.ToLower() == "completada")
            .Sum(r => r.PrecioTotal ?? 0);
        
        // Reservas pendientes
        _reservasPendientes = _reservas
            .Count(r => r.Estado?.ToLower() == "pendiente");
        
        // Ocupaci贸n promedio (porcentaje de horas reservadas)
        if (_canchas.Count > 0)
        {
            _ocupacionPromedio = _canchas.Count > 0 
                ? (int)(_reservas.Count / (decimal)(_canchas.Count * 24) * 100)
                : 0;
            _ocupacionPromedio = Math.Min(_ocupacionPromedio, 100);
        }
        
        // Clientes activos (usuarios 煤nicos con reservas)
        _clientesActivos = _reservas
            .Select(r => r.UsuarioId)
            .Distinct()
            .Count();
        
        // Reservas por cancha
        _reservasPorCancha = _reservas
            .GroupBy(r => r.CanchaId)
            .ToDictionary(g => g.Key, g => g.Count());
        
        // Ocupaci贸n por cancha
        _ocupacionPorCancha = new();
        foreach (var cancha in _canchas)
        {
            var reservasCancha = _reservas.Count(r => r.CanchaId == cancha.Id);
            var ocupacion = reservasCancha > 0 
                ? (int)(reservasCancha / (decimal)24 * 100)
                : 0;
            _ocupacionPorCancha[cancha.Id] = Math.Min(ocupacion, 100);
        }
    }
}

