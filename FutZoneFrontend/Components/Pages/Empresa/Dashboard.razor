@page "/propietario/dashboard"
@using System.Collections.Generic
@using FutZoneFrontend.Services
@using FutZoneFrontend.Services.Models
@inject ICanchasService CanchasService
@inject IReservasService ReservasService

<PageTitle>Dashboard Propietario - FutZone</PageTitle>

<div class="propietario-dashboard">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col">
                    <h1>üìä Dashboard Propietario</h1>
                    <small>Bienvenido a tu centro de control</small>
                </div>
                <div class="col-auto">
                    <div class="header-actions">
                        <button class="btn btn-light me-2" title="Actualizar datos">
                            <i class="bi bi-arrow-clockwise"></i> Actualizar
                        </button>
                        <a class="btn btn-outline-light" href="/empresa/crear">Crear Empresa</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="dashboard-content">
        <div class="container-fluid">

            <!-- Estados de Carga -->
            @if (_cargando)
            {
                <div class="alert alert-info d-flex align-items-center" role="alert">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <span>Cargando datos del dashboard...</span>
                </div>
            }

            @if (!string.IsNullOrEmpty(_mensajeError))
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle"></i> <strong>Error:</strong> @_mensajeError
                    <button type="button" class="btn-close" @onclick="() => _mensajeError = null"></button>
                </div>
            }

            <!-- KPIs Principales -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="kpi-card kpi-ingresos">
                        <div class="kpi-icon">üí∞</div>
                        <div class="kpi-body">
                            <h6>Ingresos Este Mes</h6>
                            <h2>$@_ingresosMes.ToString("F2")</h2>
                            <small>‚Üë 15% vs mes anterior</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-3">
                    <div class="kpi-card kpi-reservas">
                        <div class="kpi-icon">üìÖ</div>
                        <div class="kpi-body">
                            <h6>Reservas Pendientes</h6>
                            <h2>@_reservasPendientes</h2>
                            <small>‚ö†Ô∏è Requieren acci√≥n</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-3">
                    <div class="kpi-card kpi-ocupacion">
                        <div class="kpi-icon">üìä</div>
                        <div class="kpi-body">
                            <h6>Ocupaci√≥n Promedio</h6>
                            <h2>@_ocupacionPromedio%</h2>
                            <small>‚Üë 5% vs mes anterior</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-3">
                    <div class="kpi-card kpi-clientes">
                        <div class="kpi-icon">üë•</div>
                        <div class="kpi-body">
                            <h6>Clientes Activos</h6>
                            <h2>@_clientesActivos</h2>
                            <small>‚ûï 5 nuevos esta semana</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mis Canchas -->
            <div class="section-header">
                <h3>Mis Canchas</h3>
                <small class="text-muted">Estado general de tus canchas</small>
            </div>

            <div class="canchas-grid">
                @if (_canchas == null || _canchas.Count == 0)
                {
                    <div class="alert alert-info">No hay canchas registradas.</div>
                }
                else
                {
                    @foreach (var cancha in _canchas)
                    {
                        <div class="cancha-card">
                            <div class="cancha-header">
                                <h5>@cancha.Nombre</h5>
                                <span class="badge @(cancha.Activa ? "bg-success" : "bg-secondary")">@(cancha.Activa ? "Activa" : "Inactiva")</span>
                            </div>
                            <div class="cancha-body">
                                <div class="cancha-stat">
                                    <span class="cancha-stat-label">Hoy</span>
                                    <span class="cancha-stat-value">@_reservasPorCancha.GetValueOrDefault(cancha.Id, 0) reservas</span>
                                </div>
                                <div class="cancha-stat">
                                    <span class="cancha-stat-label">Ocupaci√≥n</span>
                                    <span class="cancha-stat-value">@_ocupacionPorCancha.GetValueOrDefault(cancha.Id, 0)%</span>
                                </div>
                                <div class="cancha-stat">
                                    <span class="cancha-stat-label">Tarifa</span>
                                    <span class="cancha-stat-value">$@cancha.PrecioHora/hr</span>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>

            <!-- Reservas Recientes -->
            <div class="section-header">
                <h3>Reservas Recientes</h3>
                <small class="text-muted">Las √∫ltimas solicitudes de reserva</small>
            </div>

            <div class="reservas-list">
                @if (_reservas == null || _reservas.Count == 0)
                {
                    <div class="alert alert-info">No hay reservas recientes.</div>
                }
                else
                {
                    @foreach (var reserva in _reservas.Take(5))
                    {
                        <div class="reserva-item">
                            <div class="reserva-info">
                                <div class="reserva-cancha">Cancha @reserva.CanchaId</div>
                                <div class="reserva-detalles">@(reserva.FechaInicio?.ToString("dddd, HH:mm") ?? "N/A") - @(reserva.FechaFin?.ToString("HH:mm") ?? "N/A")</div>
                            </div>
                            <div>
                                <span class="reserva-status @(reserva.Estado?.ToLower() == "pendiente" ? "pendiente" : "confirmada")">@reserva.Estado</span>
                                @if (reserva.Estado?.ToLower() == "pendiente")
                                {
                                    <button class="btn btn-sm btn-success me-2" @onclick="() => AprobarReserva(reserva.Id)">Aceptar</button>
                                    <button class="btn btn-sm btn-danger">Rechazar</button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-secondary disabled">Gestionar</button>
                                }
                            </div>
                        </div>
                    }
                }
            </div>

            <!-- Acciones R√°pidas -->
            <div class="section-header">
                <h3>Acciones R√°pidas</h3>
            </div>

            <div class="quick-actions">
                <NavLink href="empresa/canchas" class="action-btn">
                    <span class="action-icon">üèüÔ∏è</span>
                    <div class="action-title">Gestionar Canchas</div>
                    <div class="action-desc">Ver y editar tus canchas</div>
                </NavLink>

                <NavLink href="empresa/reservas" class="action-btn">
                    <span class="action-icon">üìã</span>
                    <div class="action-title">Mis Reservas</div>
                    <div class="action-desc">Administrar todas las reservas</div>
                </NavLink>

                <button class="action-btn" onclick="alert('Funci√≥n disponible pronto')">
                    <span class="action-icon">üìä</span>
                    <div class="action-title">Reportes</div>
                    <div class="action-desc">Generar reportes de ingresos</div>
                </button>

                <button class="action-btn" onclick="alert('Funci√≥n disponible pronto')">
                    <span class="action-icon">‚öôÔ∏è</span>
                    <div class="action-title">Configuraci√≥n</div>
                    <div class="action-desc">Ajustar preferencias y tarifas</div>
                </button>
            </div>

            <!-- √öltimas Transacciones -->
            <div class="section-header">
                <h3>√öltimas Transacciones</h3>
                <small class="text-muted">Historial de pagos y movimientos</small>
            </div>

            <div class="transactions-table">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Concepto</th>
                            <th>Monto</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (_transacciones == null || _transacciones.Count == 0)
                        {
                            <tr>
                                <td colspan="4" class="text-center text-muted">No hay transacciones</td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var trans in _transacciones.Take(5))
                            {
                                <tr>
                                    <td>@trans["fecha"]</td>
                                    <td>@trans["concepto"]</td>
                                    <td class="transaction-amount @(trans["monto"].ToString().StartsWith("-") ? "negative" : "")">@trans["monto"]</td>
                                    <td><span class="transaction-status completada">@trans["estado"]</span></td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            <!-- Resumen Mensual -->
            <div class="section-header">
                <h3>Resumen Mensual</h3>
                <small class="text-muted">An√°lisis financiero de @DateTime.Now.ToString("MMMM yyyy", new System.Globalization.CultureInfo("es-ES"))</small>
            </div>

            <div class="row summary-cards">
                <div class="col-md-6 summary-item">
                    <div class="summary-box">
                        <h5>Ingresos Brutos</h5>
                        <div class="summary-detail">
                            <div>Reservas: <span class="amount">@((_ingresosMes * 0.95m).ToString("C"))</span></div>
                            <div>Otros servicios: <span class="amount">@((_ingresosMes * 0.05m).ToString("C"))</span></div>
                            <div class="total">Total Bruto: <span class="amount">@(_ingresosMes).ToString("C")</span></div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 summary-item">
                    <div class="summary-box">
                        <h5>Desagregaci√≥n</h5>
                        <div class="summary-detail">
                            <div>Comisi√≥n FutZone (5%): <span class="amount negative">-@((_ingresosMes * 0.05m).ToString("C"))</span></div>
                            <div>Impuestos (3%): <span class="amount negative">-@((_ingresosMes * 0.03m).ToString("C"))</span></div>
                            <div class="total">Ingreso Neto: <span class="amount success">@((_ingresosMes * 0.92m).ToString("C"))</span></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

@code {
    private bool _cargando = true;
    private string _mensajeError = string.Empty;
    
    private decimal _ingresosMes = 0;
    private int _reservasPendientes = 0;
    private int _ocupacionPromedio = 0;
    private int _clientesActivos = 0;
    
    private List<Cancha> _canchas = new();
    private List<ReservaDto> _reservas = new();
    private Dictionary<int, int> _reservasPorCancha = new();
    private Dictionary<int, int> _ocupacionPorCancha = new();
    private List<Dictionary<string, object>> _transacciones = new();
    
    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }
    
    private async Task CargarDatos()
    {
        try
        {
            _cargando = true;
            _mensajeError = string.Empty;
            
            // Cargar canchas
            _canchas = await CanchasService.GetAllCanchasAsync() ?? new();
            
            // Cargar reservas
            _reservas = await ReservasService.GetAllReservasAsync() ?? new();
            
            // Calcular m√©tricas
            CalcularMetricas();
            
            // Generar transacciones a partir de reservas
            GenerarTransacciones();
        }
        catch (Exception ex)
        {
            _mensajeError = $"Error al cargar datos: {ex.Message}";
        }
        finally
        {
            _cargando = false;
        }
    }
    
    private void CalcularMetricas()
    {
        // Ingresos del mes (suma de precios de reservas confirmadas)
        _ingresosMes = _reservas
            .Where(r => r.Estado?.ToLower() == "confirmada" || r.Estado?.ToLower() == "completada")
            .Sum(r => r.PrecioTotal ?? 0);
        
        // Reservas pendientes
        _reservasPendientes = _reservas
            .Count(r => r.Estado?.ToLower() == "pendiente");
        
        // Ocupaci√≥n promedio (porcentaje de horas reservadas)
        if (_canchas.Count > 0)
        {
            _ocupacionPromedio = _canchas.Count > 0 
                ? (int)(_reservas.Count / (decimal)(_canchas.Count * 24) * 100)
                : 0;
            _ocupacionPromedio = Math.Min(_ocupacionPromedio, 100);
        }
        
        // Clientes activos (usuarios √∫nicos con reservas)
        _clientesActivos = _reservas
            .Select(r => r.UsuarioId)
            .Distinct()
            .Count();
        
        // Reservas por cancha
        _reservasPorCancha = _reservas
            .GroupBy(r => r.CanchaId)
            .ToDictionary(g => g.Key, g => g.Count());
        
        // Ocupaci√≥n por cancha
        _ocupacionPorCancha = new();
        foreach (var cancha in _canchas)
        {
            var reservasCancha = _reservas.Count(r => r.CanchaId == cancha.Id);
            var ocupacion = reservasCancha > 0 
                ? (int)(reservasCancha / (decimal)24 * 100)
                : 0;
            _ocupacionPorCancha[cancha.Id] = Math.Min(ocupacion, 100);
        }
    }
    
    private void GenerarTransacciones()
    {
        _transacciones.Clear();
        
        // Generar transacciones a partir de reservas confirmadas
        foreach (var reserva in _reservas.Where(r => r.Estado?.ToLower() == "confirmada" || r.Estado?.ToLower() == "completada").OrderByDescending(r => r.FechaInicio).Take(5))
        {
            _transacciones.Add(new Dictionary<string, object>
            {
                { "fecha", reserva.FechaInicio?.ToString("dd MMM, yyyy", new System.Globalization.CultureInfo("es-ES")) ?? "N/A" },
                { "concepto", $"Reserva Cancha #{reserva.CanchaId}" },
                { "monto", $"+${(reserva.PrecioTotal ?? 0):F2}" },
                { "estado", "Completada" }
            });
        }
        
        // Si no hay suficientes transacciones, agregar datos de ejemplo
        if (_transacciones.Count == 0)
        {
            _transacciones.Add(new Dictionary<string, object>
            {
                { "fecha", DateTime.Now.ToString("dd MMM, yyyy", new System.Globalization.CultureInfo("es-ES")) },
                { "concepto", "Sin transacciones" },
                { "monto", "$0.00" },
                { "estado", "Pendiente" }
            });
        }
    }
    
    private async Task AprobarReserva(int reservaId)
    {
        try
        {
            await ReservasService.ProcessReservaAsync(reservaId);
            await CargarDatos();
        }
        catch (Exception ex)
        {
            _mensajeError = $"Error al aprobar reserva: {ex.Message}";
        }
    }
}
