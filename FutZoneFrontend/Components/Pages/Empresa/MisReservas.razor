@page "/empresa/reservas"
@rendermode InteractiveServer
@using System.Collections.Generic
@using System.Linq
@using FutZoneFrontend.Services
@using FutZoneFrontend.Services.Models
@inject IPropietarioService PropietarioService
@inject ICanchasService CanchasService
@inject IReservasService ReservasService
@inject IAuthService AuthService
@inject IEmpresaService EmpresaService

<div class="misreservas-container">
    <!-- HEADER CON GRADIENTE -->
    <div class="header-gradient-reservas">
        <div class="container-fluid">
            <h1 class="mb-1">üìÖ Gesti√≥n de Reservas</h1>
            <p class="subtitle">Visualiza, acepta o rechaza las reservas de tus canchas</p>
        </div>
    </div>

    <!-- Alerta de Error -->
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong>Error:</strong> @ErrorMessage
            <button type="button" class="btn-close" @onclick="() => ErrorMessage = null"></button>
        </div>
    }

    <!-- Estado de Cargando -->
    @if (IsLoading)
    {
        <div class="alert alert-info" role="alert">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <strong>Cargando reservas...</strong>
        </div>
    }

    <!-- SECCI√ìN PRINCIPAL -->
    <div class="container-fluid mt-5">
        <!-- ESTAD√çSTICAS -->
        <div class="stats-container">
            <div class="stat-card stat-card-pending">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-content">
                    <div class="stat-number">@_reservas.Count(r => r.Estado == "Pendiente")</div>
                    <div class="stat-label">Pendientes de Aprobaci√≥n</div>
                </div>
            </div>

            <div class="stat-card stat-card-approved">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-content">
                    <div class="stat-number">@_reservas.Count(r => r.Estado == "Aprobada")</div>
                    <div class="stat-label">Reservas Aprobadas</div>
                </div>
            </div>

            <div class="stat-card stat-card-rejected">
                <div class="stat-icon">‚ùå</div>
                <div class="stat-content">
                    <div class="stat-number">@_reservas.Count(r => r.Estado == "Rechazada")</div>
                    <div class="stat-label">Reservas Rechazadas</div>
                </div>
            </div>

            <div class="stat-card stat-card-revenue">
                <div class="stat-icon">üí∞</div>
                <div class="stat-content">
                    <div class="stat-number">$@_reservas.Where(r => r.Estado == "Aprobada").Sum(r => r.PrecioTotal).ToString("0.00")</div>
                    <div class="stat-label">Ingresos (Aprobadas)</div>
                </div>
            </div>
        </div>

        <!-- FILTROS -->
        <div class="filters-section mt-4">
            <div class="filter-item">
                <label>Filtrar por Estado:</label>
                <select class="form-control" @onchange="FiltrarPorEstado">
                    <option value="">Todos los estados</option>
                    <option value="Pendiente">Pendientes</option>
                    <option value="Aprobada">Aprobadas</option>
                    <option value="Rechazada">Rechazadas</option>
                </select>
            </div>

            <div class="filter-item">
                <label>Filtrar por Cancha:</label>
                <select class="form-control" @onchange="FiltrarPorCancha">
                    <option value="">Todas las canchas</option>
                    @foreach (var cancha in _canchas)
                    {
                        <option value="@cancha.Id">@cancha.Nombre</option>
                    }
                </select>
            </div>

            <div class="filter-item">
                <label>Ordenar por:</label>
                <select class="form-control" @onchange="OrdenarReservas">
                    <option value="fecha-desc">M√°s recientes</option>
                    <option value="fecha-asc">M√°s antiguas</option>
                    <option value="precio-desc">Mayor precio</option>
                    <option value="precio-asc">Menor precio</option>
                </select>
            </div>

            <div class="filter-item">
                <button class="btn btn-info" @onclick="RecargarReservas">
                    <i class="bi bi-arrow-clockwise"></i> Recargar
                </button>
            </div>
        </div>

        <!-- LISTA DE RESERVAS -->
        <div class="reservas-section mt-4">
            <h2 class="section-title">üìã Reservas de tus Canchas</h2>

            @if (_reservasFiltradas.Count == 0)
            {
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i> No hay reservas que coincidan con los filtros seleccionados.
                </div>
            }
            else
            {
                <div class="reservas-grid">
                    @foreach (var reserva in _reservasFiltradas)
                    {
                        <div class="reserva-card">
                            <!-- HEADER CON ESTADO -->
                            <div class="reserva-header">
                                <div>
                                    <h3 class="reserva-title">@reserva.CanchaNombre</h3>
                                    <small style="color: #999;">ID Reserva: #@reserva.Id</small>
                                </div>
                                <span class="estado-badge estado-@reserva.Estado.ToLower().Replace("√°", "a")">
                                    @GetEstadoIcono(reserva.Estado) @reserva.Estado
                                </span>
                            </div>

                            <!-- INFORMACI√ìN PRINCIPAL -->
                            <div class="reserva-body">
                                <!-- INFORMACI√ìN DEL CLIENTE -->
                                <div class="info-section">
                                    <h4 class="info-title">üë§ Informaci√≥n del Cliente</h4>
                                    <div class="info-item">
                                        <span class="info-label">Nombre:</span>
                                        <span class="info-value">@reserva.NombreUsuario</span>
                                    </div>
                                </div>

                                <!-- INFORMACI√ìN DE LA RESERVA -->
                                <div class="info-section">
                                    <h4 class="info-title">‚è∞ Detalles de la Reserva</h4>
                                    <div class="info-item">
                                        <span class="info-label">Fecha:</span>
                                        <span class="info-value">@reserva.Fecha.ToString("dd/MM/yyyy")</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Hora:</span>
                                        <span class="info-value">@reserva.HoraInicio - @reserva.HoraFin</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Duraci√≥n:</span>
                                        <span class="info-value">@reserva.Duracion horas</span>
                                    </div>
                                </div>

                                <!-- INFORMACI√ìN FINANCIERA -->
                                <div class="info-section">
                                    <h4 class="info-title">üíµ Informaci√≥n Financiera</h4>
                                    <div class="info-item">
                                        <span class="info-label">Precio/Hora:</span>
                                        <span class="info-value">$@reserva.PrecioHora</span>
                                    </div>
                                    <div class="info-item important">
                                        <span class="info-label">Total a Pagar:</span>
                                        <span class="info-value">$@reserva.PrecioTotal</span>
                                    </div>
                                </div>

                                <!-- HISTORIAL -->
                                <div class="info-section">
                                    <h4 class="info-title">üìÖ Historial</h4>
                                    <div class="info-item">
                                        <span class="info-label">Solicitada el:</span>
                                        <span class="info-value">@reserva.FechaSolicitud.ToString("dd/MM/yyyy HH:mm")</span>
                                    </div>
                                </div>
                            </div>

                            <!-- ACCIONES -->
                            @if (reserva.Estado?.ToLower() == "pendiente")
                            {
                                <div class="reserva-actions">
                                    <button class="btn btn-success btn-action" @onclick="() => AprobarReserva(reserva.Id)">
                                        <i class="bi bi-check-circle"></i> Aprobar
                                    </button>
                                    <button class="btn btn-danger btn-action" @onclick="() => RechazarReserva(reserva.Id)">
                                        <i class="bi bi-x-circle"></i> Rechazar
                                    </button>
                                </div>
                            }
                            else
                            {
                                <div class="reserva-actions">
                                    <button class="btn btn-secondary btn-action" disabled>
                                        <i class="bi bi-lock"></i> @(reserva.Estado?.ToLower() == "aprobada" ? "Aprobada" : "Rechazada")
                                    </button>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

<!-- MODAL RECHAZAR RESERVA -->
<div class="modal @(_mostrarModalRechazo ? "show d-block" : "")" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-circle-fill"></i> Rechazar Reserva
                </h5>
                <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalRechazo"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Por favor, proporciona un motivo para rechazar esta reserva:</p>
                <div class="form-group">
                    <label for="motivoRechazo" class="form-label">Motivo del Rechazo:</label>
                    <textarea 
                        id="motivoRechazo" 
                        class="form-control" 
                        rows="4" 
                        placeholder="Ejemplo: Horario incompatible con el mantenimiento, cancha no disponible en esa fecha, etc."
                        @bind="_motivoRechazo">
                    </textarea>
                </div>
                @if (!string.IsNullOrEmpty(ErrorMessage))
                {
                    <div class="alert alert-danger mt-3" role="alert">
                        <i class="bi bi-exclamation-triangle-fill"></i> @ErrorMessage
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CerrarModalRechazo">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" @onclick="ConfirmarRechazo">
                    <i class="bi bi-check-circle"></i> Confirmar Rechazo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Backdrop Modal -->
@if (_mostrarModalRechazo)
{
    <div class="modal-backdrop fade show"></div>
}

@code {
    // MODELO DE DATOS
    public class ReservaViewModel
    {
        public int Id { get; set; }
        public int CanchaId { get; set; }
        public string CanchaNombre { get; set; } = string.Empty;
        public string NombreUsuario { get; set; } = string.Empty;
        public DateTime Fecha { get; set; }
        public string HoraInicio { get; set; } = string.Empty;
        public string HoraFin { get; set; } = string.Empty;
        public int Duracion { get; set; }
        public decimal PrecioHora { get; set; }
        public decimal PrecioTotal { get; set; }
        public string Estado { get; set; } = "Pendiente";
        public DateTime FechaSolicitud { get; set; }
    }

    public class CanchaViewModel
    {
        public int Id { get; set; }
        public string Nombre { get; set; } = string.Empty;
    }

    // PROPIEDADES
    private List<ReservaViewModel> _reservas = new();
    private List<ReservaViewModel> _reservasFiltradas = new();
    private List<CanchaViewModel> _canchas = new();
    private List<UsuarioMembresia> _membresias = new();
    private string _filtroEstado = string.Empty;
    private int _filtroCancha = 0;
    private string _ordenamiento = "fecha-desc";
    private bool IsLoading = true;
    private string ErrorMessage = string.Empty;

    // PROPIEDADES PARA MODAL DE RECHAZO
    private bool _mostrarModalRechazo = false;
    private int _reservaIdParaRechazar = 0;
    private string _motivoRechazo = string.Empty;

    // CICLO DE VIDA
    protected override async Task OnInitializedAsync()
    {
        try
        {
            Console.WriteLine("[MisReservas] ========== INICIO OnInitializedAsync ==========");
            IsLoading = true;
            await CargarDatos();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error al cargar datos: {ex.Message}";
            Console.WriteLine($"[MisReservas] ‚ùå EXCEPCI√ìN EN OnInitializedAsync: {ex.Message}");
            Console.WriteLine($"[MisReservas] Stack: {ex.StackTrace}");
        }
        finally
        {
            IsLoading = false;
            AplicarFiltros();
            Console.WriteLine("[MisReservas] ========== FIN OnInitializedAsync ==========");
        }
    }

    // M√âTODOS DE CARGA
    private async Task CargarDatos()
    {
        try
        {
            Console.WriteLine("[MisReservas] Iniciando carga de datos...");
            
            // Obtener empresas del usuario logueado
            var empresasDelUsuario = await EmpresaService.GetEmpresasDelUsuarioAsync();
            var idsEmpresasUsuario = empresasDelUsuario.Select(e => e.ID).ToList();
            Console.WriteLine($"[MisReservas] IDs de empresas del usuario: {string.Join(", ", idsEmpresasUsuario)}");
            
            // Cargar membres√≠as del usuario
            var membresiasResponse = await PropietarioService.GetMisMembresiasAsync();
            if (membresiasResponse.Success)
            {
                _membresias = membresiasResponse.Data;
                Console.WriteLine($"[MisReservas] Membres√≠as cargadas: {_membresias.Count}");
            }

            // Cargar TODAS las canchas
            var canchasResult = await CanchasService.GetAllCanchasAsync();
            Console.WriteLine($"[MisReservas] Total de canchas en el sistema: {canchasResult?.Count ?? 0}");
            
            // Identificar las canchas que pertenecen a mis empresas
            var idsCanchasMisEmpresas = new List<int>();
            
            if (canchasResult != null && canchasResult.Count > 0)
            {
                // Guardar TODAS las canchas para el dropdown
                _canchas = canchasResult
                    .Select(c => new CanchaViewModel { Id = c.Id, Nombre = c.Nombre })
                    .ToList();
                
                Console.WriteLine($"[MisReservas] Canchas cargadas para dropdown: {_canchas.Count}");
                
                // Filtrar canchas que pertenecen a mis empresas
                foreach (var cancha in canchasResult)
                {
                    Console.WriteLine($"  - Cancha ID: {cancha.Id}, Nombre: {cancha.Nombre}, EmpresaId: {cancha.EmpresaId}");
                    
                    // Si la cancha tiene EmpresaId y pertenece a una de mis empresas, agregarla
                    if (cancha.EmpresaId.HasValue && idsEmpresasUsuario.Contains(cancha.EmpresaId.Value))
                    {
                        idsCanchasMisEmpresas.Add(cancha.Id);
                        Console.WriteLine($"    ‚úì Esta cancha pertenece a mi empresa");
                    }
                }
                
                Console.WriteLine($"[MisReservas] IDs de canchas que son M√çAs: {string.Join(", ", idsCanchasMisEmpresas)}");
            }

            // Cargar TODAS las reservas
            var todasLasReservas = await ReservasService.GetAllReservasAsync();
            Console.WriteLine($"[MisReservas] Total de reservas en el sistema: {todasLasReservas?.Count ?? 0}");

            if (todasLasReservas != null && todasLasReservas.Count > 0)
            {
                // Mostrar TODAS las reservas (sin filtrar) para debug
                Console.WriteLine("[MisReservas] ‚ö†Ô∏è MOSTRANDO TODAS LAS RESERVAS SIN FILTRAR POR AHORA");
                
                _reservas = todasLasReservas
                    .Select(r => new ReservaViewModel
                    {
                        Id = r.Id,
                        CanchaId = r.CanchaId,
                        CanchaNombre = _canchas.FirstOrDefault(c => c.Id == r.CanchaId)?.Nombre ?? $"Cancha {r.CanchaId}",
                        NombreUsuario = r.NombreUsuario ?? string.Empty,
                        Fecha = r.FechaReserva?.Date ?? DateTime.Now,
                        HoraInicio = r.HoraInicio ?? "00:00",
                        HoraFin = r.HoraFin ?? "00:00",
                        Duracion = string.IsNullOrEmpty(r.DuracionHoras) ? 0 : (int)Math.Round(decimal.Parse(r.DuracionHoras)),
                        PrecioHora = (r.PrecioTotal ?? 0) / (string.IsNullOrEmpty(r.DuracionHoras) ? 1 : decimal.Parse(r.DuracionHoras)),
                        PrecioTotal = r.PrecioTotal ?? (string.IsNullOrEmpty(r.MontoTotal) ? 0 : decimal.Parse(r.MontoTotal)),
                        Estado = r.Estado ?? "Pendiente",
                        FechaSolicitud = r.FechaReserva ?? DateTime.Now
                    })
                    .ToList();
                
                Console.WriteLine($"[MisReservas] TODAS las reservas mostradas: {_reservas.Count}");
                foreach (var reserva in _reservas)
                {
                    Console.WriteLine($"  - Reserva ID: {reserva.Id}, CanchaId: {reserva.CanchaId}, CanchaNombre: {reserva.CanchaNombre}, Usuario: {reserva.NombreUsuario}, Estado: {reserva.Estado}");
                }
            }
            else
            {
                Console.WriteLine("[MisReservas] No hay reservas en el sistema");
                _reservas = new List<ReservaViewModel>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MisReservas] Error cargando datos: {ex.Message}");
            Console.WriteLine($"[MisReservas] Stack trace: {ex.StackTrace}");
            ErrorMessage = $"Error cargando datos: {ex.Message}";
        }
    }

    // M√âTODOS DE FILTRADO
    private void FiltrarPorEstado(ChangeEventArgs e)
    {
        _filtroEstado = e.Value?.ToString() ?? string.Empty;
        AplicarFiltros();
    }

    private void FiltrarPorCancha(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            _filtroCancha = id;
        }
        else
        {
            _filtroCancha = 0;
        }
        AplicarFiltros();
    }

    private void OrdenarReservas(ChangeEventArgs e)
    {
        _ordenamiento = e.Value?.ToString() ?? "fecha-desc";
        AplicarFiltros();
    }

    private void AplicarFiltros()
    {
        _reservasFiltradas = _reservas
            .Where(r => string.IsNullOrEmpty(_filtroEstado) || r.Estado == _filtroEstado)
            .Where(r => _filtroCancha == 0 || r.CanchaId == _filtroCancha)
            .ToList();

        // Aplicar ordenamiento
        _reservasFiltradas = _ordenamiento switch
        {
            "fecha-asc" => _reservasFiltradas.OrderBy(r => r.Fecha).ToList(),
            "precio-desc" => _reservasFiltradas.OrderByDescending(r => r.PrecioTotal).ToList(),
            "precio-asc" => _reservasFiltradas.OrderBy(r => r.PrecioTotal).ToList(),
            _ => _reservasFiltradas.OrderByDescending(r => r.Fecha).ToList()
        };
    }

    private async Task RecargarReservas()
    {
        try
        {
            IsLoading = true;
            Console.WriteLine("[MisReservas] Recargando reservas manualmente...");
            await CargarDatos();
            AplicarFiltros();
            StateHasChanged();
            Console.WriteLine("[MisReservas] Reservas recargadas exitosamente");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error al recargar: {ex.Message}";
            Console.WriteLine($"[MisReservas] Error recargando: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    // M√âTODOS DE ACCI√ìN
    private async Task AprobarReserva(int id)
    {
        try
        {
            var reserva = _reservas.FirstOrDefault(r => r.Id == id);
            if (reserva != null)
            {
                // Obtener ID del usuario logueado
                await AuthService.EnsureAuthDataLoadedAsync();
                var usuarioId = await AuthService.GetUserIdAsync();
                
                if (!usuarioId.HasValue || usuarioId <= 0)
                {
                    ErrorMessage = "No se pudo obtener el ID del usuario logueado";
                    return;
                }
                
                var resultado = await ReservasService.AprobarReservaAsync(id, usuarioId.Value);
                if (resultado)
                {
                    reserva.Estado = "Aprobada";
                    AplicarFiltros();
                    StateHasChanged();
                }
                else
                {
                    ErrorMessage = "Error al aprobar la reserva";
                }
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task RechazarReserva(int id)
    {
        try
        {
            // Abrir modal para ingresar motivo
            _reservaIdParaRechazar = id;
            _motivoRechazo = string.Empty;
            _mostrarModalRechazo = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task ConfirmarRechazo()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(_motivoRechazo))
            {
                ErrorMessage = "Por favor ingresa un motivo para el rechazo";
                return;
            }

            var reserva = _reservas.FirstOrDefault(r => r.Id == _reservaIdParaRechazar);
            if (reserva != null)
            {
                // Obtener ID del usuario logueado
                await AuthService.EnsureAuthDataLoadedAsync();
                var usuarioId = await AuthService.GetUserIdAsync();
                
                if (!usuarioId.HasValue || usuarioId <= 0)
                {
                    ErrorMessage = "No se pudo obtener el ID del usuario logueado";
                    return;
                }

                var resultado = await ReservasService.RechazarReservaAsync(_reservaIdParaRechazar, usuarioId.Value, _motivoRechazo);
                if (resultado)
                {
                    reserva.Estado = "Rechazada";
                    AplicarFiltros();
                    CerrarModalRechazo();
                    StateHasChanged();
                }
                else
                {
                    ErrorMessage = "Error al rechazar la reserva";
                }
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error: {ex.Message}";
        }
    }

    private void CerrarModalRechazo()
    {
        _mostrarModalRechazo = false;
        _reservaIdParaRechazar = 0;
        _motivoRechazo = string.Empty;
    }

    // M√âTODOS DE UTILIDAD
    private string GetEstadoIcono(string estado)
    {
        return estado switch
        {
            "Pendiente" => "‚è≥",
            "Aprobada" => "‚úÖ",
            "Rechazada" => "‚ùå",
            _ => "‚ùì"
        };
    }
}
