@page "/empresa/reservas"
@rendermode InteractiveServer
@using System.Collections.Generic
@using System.Linq
@using FutZoneFrontend.Services
@using FutZoneFrontend.Services.Models
@inject IPropietarioService PropietarioService

<div class="misreservas-container">
    <!-- HEADER CON GRADIENTE -->
    <div class="header-gradient-reservas">
        <div class="container-fluid">
            <h1 class="mb-1">üìÖ Gesti√≥n de Reservas</h1>
            <p class="subtitle">Visualiza, acepta o rechaza las reservas de tus canchas</p>
        </div>
    </div>

    <!-- SECCI√ìN PRINCIPAL -->
    <div class="container-fluid mt-5">
        <!-- ESTAD√çSTICAS -->
        <div class="stats-container">
            <div class="stat-card stat-card-pending">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-content">
                    <div class="stat-number">@_reservas.Count(r => r.Estado == "Pendiente")</div>
                    <div class="stat-label">Pendientes de Aprobaci√≥n</div>
                </div>
            </div>

            <div class="stat-card stat-card-approved">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-content">
                    <div class="stat-number">@_reservas.Count(r => r.Estado == "Aprobada")</div>
                    <div class="stat-label">Reservas Aprobadas</div>
                </div>
            </div>

            <div class="stat-card stat-card-rejected">
                <div class="stat-icon">‚ùå</div>
                <div class="stat-content">
                    <div class="stat-number">@_reservas.Count(r => r.Estado == "Rechazada")</div>
                    <div class="stat-label">Reservas Rechazadas</div>
                </div>
            </div>

            <div class="stat-card stat-card-revenue">
                <div class="stat-icon">üí∞</div>
                <div class="stat-content">
                    <div class="stat-number">$@_reservas.Where(r => r.Estado == "Aprobada").Sum(r => r.PrecioTotal).ToString("0.00")</div>
                    <div class="stat-label">Ingresos (Aprobadas)</div>
                </div>
            </div>
        </div>

        <!-- FILTROS -->
        <div class="filters-section mt-4">
            <div class="filter-item">
                <label>Filtrar por Estado:</label>
                <select class="form-control" @onchange="FiltrarPorEstado">
                    <option value="">Todos los estados</option>
                    <option value="Pendiente">Pendientes</option>
                    <option value="Aprobada">Aprobadas</option>
                    <option value="Rechazada">Rechazadas</option>
                </select>
            </div>

            <div class="filter-item">
                <label>Filtrar por Cancha:</label>
                <select class="form-control" @onchange="FiltrarPorCancha">
                    <option value="">Todas las canchas</option>
                    @foreach (var cancha in _canchas)
                    {
                        <option value="@cancha.Id">@cancha.Nombre</option>
                    }
                </select>
            </div>

            <div class="filter-item">
                <label>Ordenar por:</label>
                <select class="form-control" @onchange="OrdenarReservas">
                    <option value="fecha-desc">M√°s recientes</option>
                    <option value="fecha-asc">M√°s antiguas</option>
                    <option value="precio-desc">Mayor precio</option>
                    <option value="precio-asc">Menor precio</option>
                </select>
            </div>
        </div>

        <!-- LISTA DE RESERVAS -->
        <div class="reservas-section mt-4">
            <h2 class="section-title">üìã Reservas de tus Canchas</h2>

            @if (_reservasFiltradas.Count == 0)
            {
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i> No hay reservas que coincidan con los filtros seleccionados.
                </div>
            }
            else
            {
                <div class="reservas-grid">
                    @foreach (var reserva in _reservasFiltradas)
                    {
                        <div class="reserva-card">
                            <!-- HEADER CON ESTADO -->
                            <div class="reserva-header">
                                <h3 class="reserva-title">@reserva.CanchaNombre</h3>
                                <span class="estado-badge estado-@reserva.Estado.ToLower().Replace("√°", "a")">
                                    @GetEstadoIcono(reserva.Estado) @reserva.Estado
                                </span>
                            </div>

                            <!-- INFORMACI√ìN PRINCIPAL -->
                            <div class="reserva-body">
                                <!-- INFORMACI√ìN DEL CLIENTE -->
                                <div class="info-section">
                                    <h4 class="info-title">üë§ Informaci√≥n del Cliente</h4>
                                    <div class="info-item">
                                        <span class="info-label">Nombre:</span>
                                        <span class="info-value">@reserva.NombreCliente</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Email:</span>
                                        <span class="info-value">@reserva.EmailCliente</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Tel√©fono:</span>
                                        <span class="info-value">@reserva.TelefonoCliente</span>
                                    </div>
                                </div>

                                <!-- INFORMACI√ìN DE LA RESERVA -->
                                <div class="info-section">
                                    <h4 class="info-title">‚è∞ Detalles de la Reserva</h4>
                                    <div class="info-item">
                                        <span class="info-label">Fecha:</span>
                                        <span class="info-value">@reserva.Fecha.ToString("dd/MM/yyyy")</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Hora:</span>
                                        <span class="info-value">@reserva.HoraInicio - @reserva.HoraFin</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Duraci√≥n:</span>
                                        <span class="info-value">@reserva.Duracion horas</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Cantidad Jugadores:</span>
                                        <span class="info-value">@reserva.CantidadJugadores personas</span>
                                    </div>
                                </div>

                                <!-- INFORMACI√ìN FINANCIERA -->
                                <div class="info-section">
                                    <h4 class="info-title">üíµ Informaci√≥n Financiera</h4>
                                    <div class="info-item">
                                        <span class="info-label">Precio/Hora:</span>
                                        <span class="info-value">${{reserva.PrecioHora}}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Descuento:</span>
                                        <span class="info-value">-${reserva.Descuento}</span>
                                    </div>
                                    <div class="info-item important">
                                        <span class="info-label">Total a Pagar:</span>
                                        <span class="info-value">${reserva.PrecioTotal}</span>
                                    </div>
                                </div>

                                <!-- NOTAS DEL CLIENTE -->
                                @if (!string.IsNullOrEmpty(reserva.NotasCliente))
                                {
                                    <div class="info-section">
                                        <h4 class="info-title">üìù Notas del Cliente</h4>
                                        <div class="notes-box">
                                            @reserva.NotasCliente
                                        </div>
                                    </div>
                                }

                                <!-- HISTORIAL -->
                                <div class="info-section">
                                    <h4 class="info-title">üìÖ Historial</h4>
                                    <div class="info-item">
                                        <span class="info-label">Solicitada el:</span>
                                        <span class="info-value">@reserva.FechaSolicitud.ToString("dd/MM/yyyy HH:mm")</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(reserva.FechaRespuesta))
                                    {
                                        <div class="info-item">
                                            <span class="info-label">Respondida el:</span>
                                            <span class="info-value">@reserva.FechaRespuesta</span>
                                        </div>
                                    }
                                </div>
                            </div>

                            <!-- ACCIONES -->
                            @if (reserva.Estado == "Pendiente")
                            {
                                <div class="reserva-actions">
                                    <button class="btn btn-success btn-action" @onclick="() => AprobarReserva(reserva.Id)">
                                        <i class="bi bi-check-circle"></i> Aprobar
                                    </button>
                                    <button class="btn btn-danger btn-action" @onclick="() => RechazarReserva(reserva.Id)">
                                        <i class="bi bi-x-circle"></i> Rechazar
                                    </button>
                                </div>
                            }
                            else
                            {
                                <div class="reserva-actions">
                                    <button class="btn btn-secondary btn-action" disabled>
                                        <i class="bi bi-lock"></i> @(reserva.Estado == "Aprobada" ? "Aprobada" : "Rechazada")
                                    </button>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {
    // MODELO DE DATOS
    public class Reserva
    {
        public int Id { get; set; }
        public int CanchaId { get; set; }
        public string CanchaNombre { get; set; } = string.Empty;
        public string NombreCliente { get; set; } = string.Empty;
        public string EmailCliente { get; set; } = string.Empty;
        public string TelefonoCliente { get; set; } = string.Empty;
        public DateTime Fecha { get; set; }
        public string HoraInicio { get; set; } = string.Empty;
        public string HoraFin { get; set; } = string.Empty;
        public int Duracion { get; set; }
        public int CantidadJugadores { get; set; }
        public decimal PrecioHora { get; set; }
        public decimal Descuento { get; set; }
        public decimal PrecioTotal { get; set; }
        public string NotasCliente { get; set; } = string.Empty;
        public string Estado { get; set; } = "Pendiente"; // Pendiente, Aprobada, Rechazada
        public DateTime FechaSolicitud { get; set; }
        public string FechaRespuesta { get; set; } = string.Empty;
    }

    public class Cancha
    {
        public int Id { get; set; }
        public string Nombre { get; set; } = string.Empty;
    }

    // PROPIEDADES
    private List<Reserva> _reservas = new();
    private List<Reserva> _reservasFiltradas = new();
    private List<Cancha> _canchas = new();
    private List<UsuarioMembresia> _membresias = new();
    private string _filtroEstado = string.Empty;
    private int _filtroCancha = 0;
    private string _ordenamiento = "fecha-desc";
    private bool IsLoading = true;
    private string ErrorMessage = string.Empty;

    // CICLO DE VIDA
    protected override async Task OnInitializedAsync()
    {
        try
        {
            IsLoading = true;
            // Cargar membres√≠as del usuario
            var membresiasResponse = await PropietarioService.GetMisMembresiasAsync();
            if (membresiasResponse.Success)
            {
                _membresias = membresiasResponse.Data;
                Console.WriteLine($"Membres√≠as cargadas: {_membresias.Count}");
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error al cargar membres√≠as: {ex.Message}";
            Console.WriteLine($"Excepci√≥n: {ex}");
        }
        finally
        {
            IsLoading = false;
            CargarDatos();
            AplicarFiltros();
        }
    }

    // M√âTODOS DE CARGA
    private void CargarDatos()
    {
        // Cargar canchas
        _canchas = new List<Cancha>
        {
            new Cancha { Id = 1, Nombre = "Cancha Principal" },
            new Cancha { Id = 2, Nombre = "Cancha Secundaria" },
            new Cancha { Id = 3, Nombre = "Cancha Entrenamiento" }
        };

        // Cargar reservas de ejemplo
        _reservas = new List<Reserva>
        {
            new Reserva
            {
                Id = 1,
                CanchaId = 1,
                CanchaNombre = "Cancha Principal",
                NombreCliente = "Juan Garc√≠a L√≥pez",
                EmailCliente = "juan.garcia@email.com",
                TelefonoCliente = "+34 612 345 678",
                Fecha = DateTime.Now.AddDays(2),
                HoraInicio = "18:00",
                HoraFin = "20:00",
                Duracion = 2,
                CantidadJugadores = 22,
                PrecioHora = 50,
                Descuento = 0,
                PrecioTotal = 100,
                NotasCliente = "Necesitamos la cancha con bal√≥n incluido. Gracias.",
                Estado = "Pendiente",
                FechaSolicitud = DateTime.Now,
                FechaRespuesta = string.Empty
            },
            new Reserva
            {
                Id = 2,
                CanchaId = 1,
                CanchaNombre = "Cancha Principal",
                NombreCliente = "Carlos Mart√≠nez Ruiz",
                EmailCliente = "carlos.martinez@email.com",
                TelefonoCliente = "+34 623 456 789",
                Fecha = DateTime.Now.AddDays(5),
                HoraInicio = "19:00",
                HoraFin = "21:00",
                Duracion = 2,
                CantidadJugadores = 18,
                PrecioHora = 50,
                Descuento = 5,
                PrecioTotal = 95,
                NotasCliente = string.Empty,
                Estado = "Aprobada",
                FechaSolicitud = DateTime.Now.AddDays(-2),
                FechaRespuesta = "Aprobada el " + DateTime.Now.AddDays(-2).ToString("dd/MM/yyyy HH:mm")
            },
            new Reserva
            {
                Id = 3,
                CanchaId = 2,
                CanchaNombre = "Cancha Secundaria",
                NombreCliente = "Ana L√≥pez Gonz√°lez",
                EmailCliente = "ana.lopez@email.com",
                TelefonoCliente = "+34 634 567 890",
                Fecha = DateTime.Now.AddDays(-1),
                HoraInicio = "20:00",
                HoraFin = "22:00",
                Duracion = 2,
                CantidadJugadores = 16,
                PrecioHora = 35,
                Descuento = 0,
                PrecioTotal = 70,
                NotasCliente = "¬øHay estacionamiento disponible?",
                Estado = "Rechazada",
                FechaSolicitud = DateTime.Now.AddDays(-3),
                FechaRespuesta = "Rechazada el " + DateTime.Now.AddDays(-3).ToString("dd/MM/yyyy HH:mm")
            },
            new Reserva
            {
                Id = 4,
                CanchaId = 2,
                CanchaNombre = "Cancha Secundaria",
                NombreCliente = "David S√°nchez Torres",
                EmailCliente = "david.sanchez@email.com",
                TelefonoCliente = "+34 645 678 901",
                Fecha = DateTime.Now.AddDays(7),
                HoraInicio = "17:00",
                HoraFin = "19:00",
                Duracion = 2,
                CantidadJugadores = 14,
                PrecioHora = 35,
                Descuento = 7,
                PrecioTotal = 63,
                NotasCliente = "Torneo local. Necesitamos iluminaci√≥n extra si es posible.",
                Estado = "Pendiente",
                FechaSolicitud = DateTime.Now.AddDays(-1),
                FechaRespuesta = string.Empty
            },
            new Reserva
            {
                Id = 5,
                CanchaId = 3,
                CanchaNombre = "Cancha Entrenamiento",
                NombreCliente = "Miguel Rodr√≠guez P√©rez",
                EmailCliente = "miguel.rodriguez@email.com",
                TelefonoCliente = "+34 656 789 012",
                Fecha = DateTime.Now.AddDays(10),
                HoraInicio = "16:00",
                HoraFin = "18:00",
                Duracion = 2,
                CantidadJugadores = 12,
                PrecioHora = 25,
                Descuento = 0,
                PrecioTotal = 50,
                NotasCliente = string.Empty,
                Estado = "Aprobada",
                FechaSolicitud = DateTime.Now.AddDays(-5),
                FechaRespuesta = "Aprobada el " + DateTime.Now.AddDays(-5).ToString("dd/MM/yyyy HH:mm")
            }
        };
    }

    // M√âTODOS DE FILTRADO
    private void FiltrarPorEstado(ChangeEventArgs e)
    {
        _filtroEstado = e.Value?.ToString() ?? string.Empty;
        AplicarFiltros();
    }

    private void FiltrarPorCancha(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            _filtroCancha = id;
        }
        else
        {
            _filtroCancha = 0;
        }
        AplicarFiltros();
    }

    private void OrdenarReservas(ChangeEventArgs e)
    {
        _ordenamiento = e.Value?.ToString() ?? "fecha-desc";
        AplicarFiltros();
    }

    private void AplicarFiltros()
    {
        _reservasFiltradas = _reservas
            .Where(r => string.IsNullOrEmpty(_filtroEstado) || r.Estado == _filtroEstado)
            .Where(r => _filtroCancha == 0 || r.CanchaId == _filtroCancha)
            .ToList();

        // Aplicar ordenamiento
        _reservasFiltradas = _ordenamiento switch
        {
            "fecha-asc" => _reservasFiltradas.OrderBy(r => r.Fecha).ToList(),
            "precio-desc" => _reservasFiltradas.OrderByDescending(r => r.PrecioTotal).ToList(),
            "precio-asc" => _reservasFiltradas.OrderBy(r => r.PrecioTotal).ToList(),
            _ => _reservasFiltradas.OrderByDescending(r => r.Fecha).ToList()
        };
    }

    // M√âTODOS DE ACCI√ìN
    private void AprobarReserva(int id)
    {
        var reserva = _reservas.FirstOrDefault(r => r.Id == id);
        if (reserva != null)
        {
            reserva.Estado = "Aprobada";
            reserva.FechaRespuesta = "Aprobada el " + DateTime.Now.ToString("dd/MM/yyyy HH:mm");
            AplicarFiltros();
        }
    }

    private void RechazarReserva(int id)
    {
        var reserva = _reservas.FirstOrDefault(r => r.Id == id);
        if (reserva != null)
        {
            reserva.Estado = "Rechazada";
            reserva.FechaRespuesta = "Rechazada el " + DateTime.Now.ToString("dd/MM/yyyy HH:mm");
            AplicarFiltros();
        }
    }

    // M√âTODOS DE UTILIDAD
    private string GetEstadoIcono(string estado)
    {
        return estado switch
        {
            "Pendiente" => "‚è≥",
            "Aprobada" => "‚úÖ",
            "Rechazada" => "‚ùå",
            _ => "‚ùì"
        };
    }
}
