@page "/empresa/canchas"
@rendermode InteractiveServer
@using FutZoneFrontend.Services
@using FutZoneFrontend.Services.Models
@using FutZoneFrontend.DTOs
@using Microsoft.AspNetCore.Components.Forms
@inject ICanchasService CanchasService
@inject IEmpresaService EmpresaService
@inject IAuthService AuthService
@inject ITipoDeporteService TipoDeporteService

<div class="container-fluid py-4">
    <!-- Header con Gradiente -->
    <div class="header-gradient-empresas mb-5">
        <div class="container">
            <h1 class="display-5 fw-bold text-white mb-2">
                <i class="bi bi-football"></i> Gestión de Canchas
            </h1>
            <p class="text-white-50">Administra tus canchas, horarios y disponibilidad</p>
        </div>
    </div>

    <!-- Alerta de Error -->
    @if (!string.IsNullOrEmpty(_mensajeError))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong>Error:</strong> @_mensajeError
            <button type="button" class="btn-close" @onclick="() => _mensajeError = null"></button>
        </div>
    }

    <!-- Estado de Cargando -->
    @if (_cargando)
    {
        <div class="alert alert-info" role="alert">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <strong>Cargando canchas...</strong>
        </div>
    }

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="stat-card gradient-blue">
                <div class="stat-icon">
                    <i class="bi bi-pin-map-fill"></i>
                </div>
                <div class="stat-content">
                    <h5>Canchas Activas</h5>
                    <p class="stat-number">@_canchas.Count(c => c.Activa)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card gradient-green">
                <div class="stat-icon">
                    <i class="bi bi-calendar-check-fill"></i>
                </div>
                <div class="stat-content">
                    <h5>Reservas Hoy</h5>
                    <p class="stat-number">@_reservasHoy</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card gradient-orange">
                <div class="stat-icon">
                    <i class="bi bi-clock-fill"></i>
                </div>
                <div class="stat-content">
                    <h5>Horas Libres</h5>
                    <p class="stat-number">@_horasLibres</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card gradient-purple">
                <div class="stat-icon">
                    <i class="bi bi-cash-coin"></i>
                </div>
                <div class="stat-content">
                    <h5>Ingresos (Mes)</h5>
                    <p class="stat-number">$@_ingresosMes</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Botón Crear Nueva Cancha -->
    <div class="mb-4 d-flex justify-content-between align-items-center">
        <h4>
            <i class="bi bi-list-ul"></i> Mis Canchas
        </h4>
        <button class="btn btn-success btn-lg" @onclick="AbrirModalCrearCancha">
            <i class="bi bi-plus-circle-fill"></i> Nueva Cancha
        </button>
    </div>

    <!-- Tabla de Canchas -->
    @if (_canchas.Count == 0)
    {
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle-fill"></i>
            <strong>Sin canchas registradas.</strong> Crea tu primera cancha para comenzar a recibir reservas.
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var cancha in _canchas)
            {
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="cancha-card @(cancha.Activa ? "" : "deshabilitada")">
                        <!-- Header Cancha -->
                        <div class="cancha-header">
                            <div class="cancha-info">
                                <h5 class="cancha-nombre">@cancha.Nombre</h5>
                                <p class="cancha-ubicacion">
                                    <i class="bi bi-geo-alt-fill"></i> @cancha.Ubicacion
                                </p>
                            </div>
                            <div class="cancha-estado">
                                @if (cancha.Activa)
                                {
                                    <span class="badge bg-success">ACTIVA</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">DESHABILITADA</span>
                                }
                            </div>
                        </div>

                        <!-- Detalles de la Cancha -->
                        <div class="cancha-details">
                            <div class="detail-row">
                                <span class="detail-label"><i class="bi bi-rulers"></i> Dimensiones:</span>
                                <span class="detail-value">@cancha.Dimensiones</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label"><i class="bi bi-cash"></i> Precio/Hora:</span>
                                <span class="detail-value text-success fw-bold">$@cancha.PrecioHora</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label"><i class="bi bi-clock"></i> Horario:</span>
                                <span class="detail-value">@cancha.HoraApertura - @cancha.HoraCierre</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label"><i class="bi bi-people-fill"></i> Capacidad:</span>
                                <span class="detail-value">@cancha.CapacidadJugadores personas</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label"><i class="bi bi-calendar2-check"></i> Tipo Superficie:</span>
                                <span class="detail-value">@cancha.TipoSuperficie</span>
                            </div>
                        </div>

                        <!-- Horarios Disponibles -->
                        <div class="horarios-section">
                            <h6 class="horarios-title">
                                <i class="bi bi-calendar-event"></i> Horarios Disponibles
                            </h6>
                            <div class="horarios-grid">
                                @foreach (var horario in cancha.HorariosDisponibles)
                                {
                                    <div class="horario-badge @(horario.Disponible ? "disponible" : "ocupado")">
                                        <span class="horario-hora">@horario.Hora</span>
                                        <span class="horario-estado">
                                            @if (horario.Disponible)
                                            {
                                                <i class="bi bi-check-circle-fill"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-x-circle-fill"></i>
                                            }
                                        </span>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Días Disponibles -->
                        <div class="dias-section">
                            <h6 class="dias-title">
                                <i class="bi bi-calendar3"></i> Disponibles Estos Días
                            </h6>
                            <div class="dias-grid">
                                <span class="dia-badge @(cancha.DiasDisponibles.Contains("Lunes") ? "activo" : "inactivo")">Lun</span>
                                <span class="dia-badge @(cancha.DiasDisponibles.Contains("Martes") ? "activo" : "inactivo")">Mar</span>
                                <span class="dia-badge @(cancha.DiasDisponibles.Contains("Miércoles") ? "activo" : "inactivo")">Mié</span>
                                <span class="dia-badge @(cancha.DiasDisponibles.Contains("Jueves") ? "activo" : "inactivo")">Jue</span>
                                <span class="dia-badge @(cancha.DiasDisponibles.Contains("Viernes") ? "activo" : "inactivo")">Vie</span>
                                <span class="dia-badge @(cancha.DiasDisponibles.Contains("Sábado") ? "activo" : "inactivo")">Sáb</span>
                                <span class="dia-badge @(cancha.DiasDisponibles.Contains("Domingo") ? "activo" : "inactivo")">Dom</span>
                            </div>
                        </div>

                        <!-- Botones de Acción -->
                        <div class="cancha-actions">
                            <button class="btn btn-sm btn-primary" @onclick="() => AbrirModalEditar(cancha)">
                                <i class="bi bi-pencil-fill"></i> Editar
                            </button>
                            @if (cancha.Activa)
                            {
                                <button class="btn btn-sm btn-warning" @onclick="() => DeshabilitarCancha(cancha.Id)">
                                    <i class="bi bi-lock-fill"></i> Deshabilitar
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-sm btn-info" @onclick="() => HabilitarCancha(cancha.Id)">
                                    <i class="bi bi-unlock-fill"></i> Habilitar
                                </button>
                            }
                            <button class="btn btn-sm btn-danger" @onclick="() => ConfirmarEliminar(cancha)">
                                <i class="bi bi-trash-fill"></i> Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Modal Crear/Editar Cancha -->
<div class="modal @(_mostrarModalCancha ? "show d-block" : "")" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-football"></i>
                    @(_editandoCancha != null ? "Editar Cancha" : "Crear Nueva Cancha")
                </h5>
                <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalCancha"></button>
            </div>
            <div class="modal-body">
                <form>
                    <!-- Selector de Empresa -->
                    <div class="mb-3">
                        <label for="empresa" class="form-label fw-bold">Empresa</label>
                        <select class="form-select" id="empresa" @bind="_empresaSeleccionada" required>
                            <option value="0">-- Selecciona una empresa --</option>
                            @foreach (var empresa in _empresasDisponibles)
                            {
                                <option value="@empresa.ID">@empresa.Nombre</option>
                            }
                        </select>
                        @if (_empresaSeleccionada <= 0)
                        {
                            <small class="text-danger">Debes seleccionar una empresa</small>
                        }
                    </div>

                    <!-- Selector de Tipo de Deporte -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label for="tipoDeporte" class="form-label fw-bold">Tipo de Deporte</label>
                            <button type="button" class="btn btn-sm btn-outline-primary" @onclick="AbrirModalCrearDeporte">
                                <i class="bi bi-plus-circle"></i> Agregar Deporte
                            </button>
                        </div>
                        <select class="form-select" id="tipoDeporte" @bind="_tipoDeporteSeleccionado" required>
                            <option value="0">-- Selecciona un tipo de deporte --</option>
                            @foreach (var deporte in _tiposDeporte)
                            {
                                <option value="@deporte.Id">@deporte.Nombre</option>
                            }
                        </select>
                        @if (_tipoDeporteSeleccionado <= 0)
                        {
                            <small class="text-danger">Debes seleccionar un tipo de deporte</small>
                        }
                    </div>

                    <!-- Nombre de la Cancha -->
                    <div class="mb-3">
                        <label for="nombre" class="form-label fw-bold">Nombre de la Cancha</label>
                        <input type="text" class="form-control" id="nombre" 
                               placeholder="Ej. Cancha Principal" 
                               @bind="_formCancha.Nombre">
                    </div>

                    <!-- Ubicación -->
                    <div class="mb-3">
                        <label for="ubicacion" class="form-label fw-bold">Ubicación</label>
                        <input type="text" class="form-control" id="ubicacion" 
                               placeholder="Ej. Calle Principal 123" 
                               @bind="_formCancha.Ubicacion">
                    </div>

                    <div class="row">
                        <!-- Ciudad -->
                        <div class="col-md-6 mb-3">
                            <label for="ciudad" class="form-label fw-bold">Ciudad</label>
                            <input type="text" class="form-control" id="ciudad" 
                                   placeholder="Ej. Buenos Aires" 
                                   @bind="_formCancha.Ciudad">
                        </div>

                        <!-- País -->
                        <div class="col-md-6 mb-3">
                            <label for="pais" class="form-label fw-bold">País</label>
                            <input type="text" class="form-control" id="pais" 
                                   placeholder="Ej. Argentina" 
                                   @bind="_formCancha.Pais">
                        </div>
                    </div>

                    <div class="row">
                        <!-- Dimensiones -->
                        <div class="col-md-6 mb-3">
                            <label for="dimensiones" class="form-label fw-bold">Dimensiones</label>
                            <select class="form-select" id="dimensiones" @bind="_formCancha.Dimensiones">
                                <option value="">-- Seleccionar --</option>
                                <option value="5x25">5 x 25 m</option>
                                <option value="6x36">6 x 36 m</option>
                                <option value="7x42">7 x 42 m</option>
                                <option value="8x44">8 x 44 m</option>
                                <option value="9x45">9 x 45 m</option>
                            </select>
                        </div>

                        <!-- Tipo de Superficie -->
                        <div class="col-md-6 mb-3">
                            <label for="superficie" class="form-label fw-bold">Tipo de Superficie</label>
                            <select class="form-select" id="superficie" @bind="_formCancha.TipoSuperficie">
                                <option value="">-- Seleccionar --</option>
                                <option value="Cemento">Cemento</option>
                                <option value="Pasto Sintético">Pasto Sintético</option>
                                <option value="Pasto Natural">Pasto Natural</option>
                                <option value="Madera">Madera</option>
                                <option value="Arcilla">Arcilla</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Precio por Hora -->
                        <div class="col-md-6 mb-3">
                            <label for="precio" class="form-label fw-bold">Precio por Hora ($)</label>
                            <input type="number" class="form-control" id="precio" 
                                   placeholder="Ej. 50" 
                                   @bind="_formCancha.PrecioHora">
                        </div>

                        <!-- Precio Fin de Semana -->
                        <div class="col-md-6 mb-3">
                            <label for="precioFinSemana" class="form-label fw-bold">Precio Fin de Semana ($)</label>
                            <input type="number" class="form-control" id="precioFinSemana" 
                                   placeholder="Ej. 60" 
                                   @bind="_formCancha.PrecioHoraFinSemana">
                        </div>
                    </div>

                    <div class="row">
                        <!-- Capacidad -->
                        <div class="col-md-6 mb-3">
                            <label for="capacidad" class="form-label fw-bold">Capacidad (Jugadores)</label>
                            <input type="number" class="form-control" id="capacidad" 
                                   placeholder="Ej. 22" 
                                   @bind="_formCancha.CapacidadJugadores">
                        </div>

                        <!-- Está Techada -->
                        <div class="col-md-6 mb-3">
                            <label for="techada" class="form-label fw-bold">Techada</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="techada" 
                                       @bind="_formCancha.EstaTechada">
                                <label class="form-check-label" for="techada">
                                    La cancha está techada
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Hora Apertura -->
                        <div class="col-md-6 mb-3">
                            <label for="apertura" class="form-label fw-bold">Hora de Apertura</label>
                            <input type="text" class="form-control" id="apertura" 
                                   placeholder="HH:mm"
                                   @bind="_formCancha.HoraApertura">
                        </div>

                        <!-- Hora Cierre -->
                        <div class="col-md-6 mb-3">
                            <label for="cierre" class="form-label fw-bold">Hora de Cierre</label>
                            <input type="text" class="form-control" id="cierre" 
                                   placeholder="HH:mm"
                                   @bind="_formCancha.HoraCierre">
                        </div>
                    </div>

                    <div class="row">
                        <!-- Teléfono de Contacto -->
                        <div class="col-md-6 mb-3">
                            <label for="telefono" class="form-label fw-bold">Teléfono de Contacto</label>
                            <input type="tel" class="form-control" id="telefono" 
                                   placeholder="Ej. +54 11 23456789" 
                                   @bind="_formCancha.TelefonoContacto">
                        </div>

                        <!-- Email de Contacto -->
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label fw-bold">Email de Contacto</label>
                            <input type="email" class="form-control" id="email" 
                                   placeholder="Ej. contacto@cancha.com" 
                                   @bind="_formCancha.EmailContacto">
                        </div>
                    </div>

                    <div class="row">
                        <!-- Latitud -->
                        <div class="col-md-6 mb-3">
                            <label for="latitud" class="form-label fw-bold">Latitud</label>
                            <input type="number" class="form-control" id="latitud" 
                                   placeholder="-34.6037" step="0.0001"
                                   @bind="_formCancha.CoordenadasLat">
                        </div>

                        <!-- Longitud -->
                        <div class="col-md-6 mb-3">
                            <label for="longitud" class="form-label fw-bold">Longitud</label>
                            <input type="number" class="form-control" id="longitud" 
                                   placeholder="-58.3816" step="0.0001"
                                   @bind="_formCancha.CoordenadasLng">
                        </div>
                    </div>

                    <!-- Servicios Adicionales -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Servicios Adicionales</label>
                        <div class="servicios-selector">
                            @foreach (var servicio in new[] { "Vestuarios", "Estacionamiento", "WiFi" })
                            {
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="servicio_@servicio"
                                           @onchange="@((ChangeEventArgs e) => CambiarServicio(servicio, (bool)e.Value!))"
                                           checked="@(_formCancha.ServiciosAdicionales?.Contains(servicio) ?? false)">
                                    <label class="form-check-label" for="servicio_@servicio">
                                        @servicio
                                    </label>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Características -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Características</label>
                        <div class="caracteristicas-selector">
                            @foreach (var caracteristica in new[] { "Césped Sintético", "Iluminación LED", "Techada" })
                            {
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="caract_@caracteristica"
                                           @onchange="@((ChangeEventArgs e) => CambiarCaracteristica(caracteristica, (bool)e.Value!))"
                                           checked="@(_formCancha.Caracteristicas?.Contains(caracteristica) ?? false)">
                                    <label class="form-check-label" for="caract_@caracteristica">
                                        @caracteristica
                                    </label>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Días Disponibles -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Días Disponibles</label>
                        <div class="dias-selector">
                            @foreach (var dia in new[] { "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo" })
                            {
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="dia_@dia"
                                           @onchange="@((ChangeEventArgs e) => CambiarDia(dia, (bool)e.Value!))"
                                           checked="@_formCancha.DiasDisponibles.Contains(dia)">
                                    <label class="form-check-label" for="dia_@dia">
                                        @dia.Substring(0, 3)
                                    </label>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Horarios Disponibles -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-clock-fill"></i> Horarios Disponibles
                        </label>
                        <div class="horarios-selector">
                            @for (int i = 6; i <= 23; i++)
                            {
                                var hora = $"{i:D2}:00";
                                var horarioObj = _formCancha.HorariosDisponibles?.FirstOrDefault(h => h.Hora == hora);
                                var disponible = horarioObj?.Disponible ?? false;

                                <div class="form-check form-check-inline horario-check">
                                    <input class="form-check-input" type="checkbox" id="horario_@i"
                                           @onchange="@((ChangeEventArgs e) => CambiarHorario(hora, (bool)e.Value!))"
                                           checked="@disponible">
                                    <label class="form-check-label" for="horario_@i">
                                        @hora
                                    </label>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Imagen de la Cancha -->
                    <div class="mb-3">
                        <label for="imagen" class="form-label fw-bold">
                            <i class="bi bi-image"></i> Imagen de la Cancha
                        </label>
                        <input type="file" class="form-control" id="imagen" 
                               accept="image/*"
                               @onchange="CargarImagen">
                        @if (!string.IsNullOrEmpty(_imagenPreview))
                        {
                            <div class="mt-2">
                                <img src="@_imagenPreview" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                            </div>
                        }
                    </div>

                    <!-- Descripción -->
                    <div class="mb-3">
                        <label for="descripcion" class="form-label fw-bold">Descripción</label>
                        <textarea class="form-control" id="descripcion" rows="3"
                                  placeholder="Describe características especiales de tu cancha..."
                                  @bind="_formCancha.Descripcion"></textarea>
                    </div>

                    <!-- Activa -->
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="activa" 
                               @bind="_formCancha.Activa">
                        <label class="form-check-label" for="activa">
                            Cancha Activa (disponible para reservas)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CerrarModalCancha">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" @onclick="GuardarCancha">
                    <i class="bi bi-check-circle"></i> @(_editandoCancha != null ? "Actualizar" : "Crear") Cancha
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Eliminación -->
<div class="modal @(_mostrarConfirmEliminar ? "show d-block" : "")" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle-fill"></i> Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close btn-close-white" @onclick="CancelarEliminar"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar la cancha <strong>@_canchaPorEliminar?.Nombre</strong>?</p>
                <p class="text-danger">
                    <i class="bi bi-exclamation-circle-fill"></i>
                    Esta acción no se puede deshacer.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CancelarEliminar">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" @onclick="EliminarCancha">
                    <i class="bi bi-trash-fill"></i> Sí, Eliminar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear Tipo de Deporte -->
<div class="modal @(_mostrarModalDeporte ? "show d-block" : "")" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> Tipos de Deporte Disponibles
                </h5>
                <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalDeporte"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Nota: Si el deporte que buscas no está disponible, contacta al administrador para que lo agregue al sistema.</p>
                
                <div class="list-group">
                    @foreach (var deporte in _tiposDeporte)
                    {
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">@deporte.Nombre</h6>
                                @if (!string.IsNullOrEmpty(deporte.Descripcion))
                                {
                                    <small class="text-muted">@deporte.Descripcion</small>
                                }
                            </div>
                            <span class="badge bg-primary">ID: @deporte.Id</span>
                        </div>
                    }
                    @if (!_tiposDeporte.Any())
                    {
                        <div class="alert alert-warning">
                            No hay tipos de deporte disponibles. Por favor, contacta al administrador.
                        </div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CerrarModalDeporte">
                    <i class="bi bi-x-circle"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Backdrop Modal -->
@if (_mostrarModalCancha || _mostrarConfirmEliminar || _mostrarModalDeporte)
{
    <div class="modal-backdrop fade show"></div>
}

@code {
    // Clases de Datos
    public class CanchaViewModel
    {
        public int Id { get; set; }
        public string Nombre { get; set; } = "";
        public string Ubicacion { get; set; } = "";
        public string Dimensiones { get; set; } = "";
        public string TipoSuperficie { get; set; } = "";
        public string Superficie { get; set; } = "";
        public decimal PrecioHora { get; set; }
        public decimal PrecioHoraFinSemana { get; set; }
        public int CapacidadJugadores { get; set; }
        public string HoraApertura { get; set; } = "06:00";
        public string HoraCierre { get; set; } = "23:00";
        public List<string> DiasDisponibles { get; set; } = new();
        public List<HorarioDisponible> HorariosDisponibles { get; set; } = new();
        public bool Activa { get; set; } = true;
        public bool EstaTechada { get; set; } = false;
        public string Descripcion { get; set; } = "";
        public decimal? CoordenadasLat { get; set; }
        public decimal? CoordenadasLng { get; set; }
        public List<string>? ServiciosAdicionales { get; set; } = new();
        public List<string>? Caracteristicas { get; set; } = new();
        public string? Imagen { get; set; }
        public string? Ciudad { get; set; }
        public string? Pais { get; set; }
        public string? TelefonoContacto { get; set; }
        public string? EmailContacto { get; set; }
    }

    public class HorarioDisponible
    {
        public string Hora { get; set; } = "";
        public bool Disponible { get; set; }
    }

    // Variables de Estado
    private List<CanchaViewModel> _canchas = new();
    private CanchaViewModel? _editandoCancha = null;
    private CanchaViewModel _formCancha = new();
    private bool _mostrarModalCancha = false;
    private bool _mostrarConfirmEliminar = false;
    private CanchaViewModel? _canchaPorEliminar = null;
    private int _reservasHoy = 0;
    private int _horasLibres = 0;
    private decimal _ingresosMes = 0;
    private bool _cargando = true;
    private string? _mensajeError = null;
    private string? _imagenPreview = null;
    
    // Empresas
    private List<EmpresaDto> _empresasDisponibles = new();
    private int _empresaSeleccionada = 0;
    
    // Tipos de Deporte
    private List<TipoDeporte> _tiposDeporte = new();
    private int _tipoDeporteSeleccionado = 0;
    
    // Modal Crear Tipo de Deporte
    private bool _mostrarModalDeporte = false;

    protected override async Task OnInitializedAsync()
    {
        // Asegurar que los datos de autenticación están cargados
        await AuthService.EnsureAuthDataLoadedAsync();
        
        await CargarTiposDeporte();
        await CargarEmpresas();
        await CargarCanchas();
    }

    private async Task CargarTiposDeporte()
    {
        try
        {
            Console.WriteLine("[MisCanchas] Iniciando carga de tipos de deporte...");
            _tiposDeporte = await TipoDeporteService.GetAllTiposDeporteAsync();
            Console.WriteLine($"[MisCanchas] Tipos de deporte cargados: {_tiposDeporte.Count}");
            
            foreach (var deporte in _tiposDeporte)
            {
                Console.WriteLine($"  - {deporte.Nombre} (ID: {deporte.Id})");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MisCanchas] Error al cargar tipos de deporte: {ex.Message}");
            _mensajeError = $"Error al cargar tipos de deporte: {ex.Message}";
        }
    }

    private async Task CargarEmpresas()
    {
        try
        {
            Console.WriteLine("[MisCanchas] Iniciando carga de empresas...");
            _empresasDisponibles = await EmpresaService.GetEmpresasDelUsuarioAsync();
            Console.WriteLine($"[MisCanchas] Empresas cargadas: {_empresasDisponibles.Count}");
            
            foreach (var empresa in _empresasDisponibles)
            {
                Console.WriteLine($"  - {empresa.Nombre} (ID: {empresa.ID})");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MisCanchas] Error al cargar empresas: {ex.Message}");
            _mensajeError = $"Error al cargar empresas: {ex.Message}";
        }
    }

    private async Task CargarCanchas()
    {
        try
        {
            _cargando = true;
            _mensajeError = null;

            Console.WriteLine("Cargando canchas desde API...");
            var canchas = await CanchasService.GetAllCanchasAsync();
            
            _canchas = canchas.Select(c => new CanchaViewModel
            {
                Id = c.Id,
                Nombre = c.Nombre,
                Ubicacion = c.Ubicacion,
                Dimensiones = c.Dimensiones,
                TipoSuperficie = c.TipoSuperficie,
                PrecioHora = c.PrecioHora,
                CapacidadJugadores = c.CapacidadJugadores,
                HoraApertura = c.HoraApertura,
                HoraCierre = c.HoraCierre,
                Activa = c.Activa,
                Descripcion = c.Descripcion
            }).ToList();

            Console.WriteLine($"Canchas cargadas: {_canchas.Count}");

            if (_canchas.Count == 0)
            {
                _mensajeError = "No hay canchas registradas. Crea una nueva cancha para comenzar.";
            }
        }
        catch (Exception ex)
        {
            _mensajeError = $"Error al cargar canchas: {ex.Message}";
            Console.WriteLine($"Exception: {ex}");
        }
        finally
        {
            _cargando = false;
        }
    }

    private List<HorarioDisponible> GenerarHorarios(string[]? horariosOcupados = null)
    {
        horariosOcupados = horariosOcupados ?? Array.Empty<string>();
        var horarios = new List<HorarioDisponible>();
        
        for (int i = 6; i <= 23; i++)
        {
            var hora = $"{i:D2}:00";
            horarios.Add(new HorarioDisponible
            {
                Hora = hora,
                Disponible = !horariosOcupados.Contains(hora)
            });
        }
        
        return horarios;
    }

    private void AbrirModalCrearCancha()
    {
        _editandoCancha = null;
        _empresaSeleccionada = 0;
        _tipoDeporteSeleccionado = 0;
        _formCancha = new CanchaViewModel 
        { 
            DiasDisponibles = new List<string>(),
            HorariosDisponibles = GenerarHorarios(),
            Activa = true
        };
        _imagenPreview = null;
        _mostrarModalCancha = true;
    }

    private void AbrirModalEditar(CanchaViewModel cancha)
    {
        _editandoCancha = cancha;
        _formCancha = new CanchaViewModel
        {
            Id = cancha.Id,
            Nombre = cancha.Nombre,
            Ubicacion = cancha.Ubicacion,
            Dimensiones = cancha.Dimensiones,
            TipoSuperficie = cancha.TipoSuperficie,
            PrecioHora = cancha.PrecioHora,
            CapacidadJugadores = cancha.CapacidadJugadores,
            HoraApertura = cancha.HoraApertura,
            HoraCierre = cancha.HoraCierre,
            DiasDisponibles = new List<string>(cancha.DiasDisponibles),
            HorariosDisponibles = cancha.HorariosDisponibles.Select(h => new HorarioDisponible { Hora = h.Hora, Disponible = h.Disponible }).ToList(),
            Activa = cancha.Activa,
            Descripcion = cancha.Descripcion
        };
        _mostrarModalCancha = true;
    }

    private void CerrarModalCancha()
    {
        _mostrarModalCancha = false;
        _editandoCancha = null;
        _imagenPreview = null;
    }

    private async Task GuardarCancha()
    {
        if (string.IsNullOrWhiteSpace(_formCancha.Nombre))
        {
            _mensajeError = "El nombre de la cancha es requerido";
            return;
        }

        if (_empresaSeleccionada <= 0)
        {
            _mensajeError = "Debes seleccionar una empresa";
            return;
        }

        if (_tipoDeporteSeleccionado <= 0)
        {
            _mensajeError = "Debes seleccionar un tipo de deporte";
            return;
        }

        try
        {
            if (_editandoCancha != null)
            {
                // Actualizar cancha existente
                var canchaSvc = new FutZoneFrontend.Services.Models.Cancha
                {
                    Id = _formCancha.Id,
                    EmpresaId = _empresaSeleccionada,
                    TipoDeporteId = _tipoDeporteSeleccionado,
                    Nombre = _formCancha.Nombre,
                    Ubicacion = _formCancha.Ubicacion,
                    Dimensiones = _formCancha.Dimensiones,
                    TipoSuperficie = _formCancha.TipoSuperficie,
                    Superficie = _formCancha.Superficie,
                    PrecioHora = _formCancha.PrecioHora,
                    PrecioHoraFinSemana = _formCancha.PrecioHoraFinSemana,
                    CapacidadJugadores = _formCancha.CapacidadJugadores,
                    HoraApertura = _formCancha.HoraApertura,
                    HoraCierre = _formCancha.HoraCierre,
                    Activa = _formCancha.Activa,
                    EstaTechada = _formCancha.EstaTechada,
                    Descripcion = _formCancha.Descripcion,
                    CoordenadasLat = _formCancha.CoordenadasLat,
                    CoordenadasLng = _formCancha.CoordenadasLng,
                    ServiciosAdicionales = _formCancha.ServiciosAdicionales,
                    Imagen = _formCancha.Imagen,
                    Ciudad = _formCancha.Ciudad,
                    Pais = _formCancha.Pais,
                    TelefonoContacto = _formCancha.TelefonoContacto,
                    EmailContacto = _formCancha.EmailContacto,
                    Caracteristicas = _formCancha.Caracteristicas
                };
                
                var resultado = await CanchasService.UpdateCanchaAsync(_editandoCancha.Id, canchaSvc);
                if (resultado)
                {
                    await CargarCanchas();
                }
                else
                {
                    _mensajeError = "Error al actualizar la cancha";
                }
            }
            else
            {
                // Crear nueva cancha
                var canchaSvc = new FutZoneFrontend.Services.Models.Cancha
                {
                    EmpresaId = _empresaSeleccionada,
                    TipoDeporteId = _tipoDeporteSeleccionado,
                    Nombre = _formCancha.Nombre,
                    Ubicacion = _formCancha.Ubicacion,
                    Dimensiones = _formCancha.Dimensiones,
                    TipoSuperficie = _formCancha.TipoSuperficie,
                    Superficie = _formCancha.Superficie,
                    PrecioHora = _formCancha.PrecioHora,
                    PrecioHoraFinSemana = _formCancha.PrecioHoraFinSemana,
                    CapacidadJugadores = _formCancha.CapacidadJugadores,
                    HoraApertura = _formCancha.HoraApertura,
                    HoraCierre = _formCancha.HoraCierre,
                    Activa = _formCancha.Activa,
                    EstaTechada = _formCancha.EstaTechada,
                    Descripcion = _formCancha.Descripcion,
                    CoordenadasLat = _formCancha.CoordenadasLat,
                    CoordenadasLng = _formCancha.CoordenadasLng,
                    ServiciosAdicionales = _formCancha.ServiciosAdicionales,
                    Imagen = _formCancha.Imagen,
                    Ciudad = _formCancha.Ciudad,
                    Pais = _formCancha.Pais,
                    TelefonoContacto = _formCancha.TelefonoContacto,
                    EmailContacto = _formCancha.EmailContacto,
                    Caracteristicas = _formCancha.Caracteristicas
                };
                
                var nuevaCancha = await CanchasService.CreateCanchaAsync(canchaSvc);
                if (nuevaCancha != null)
                {
                    await CargarCanchas();
                }
                else
                {
                    _mensajeError = "Error al crear la cancha";
                }
            }
            
            CerrarModalCancha();
        }
        catch (Exception ex)
        {
            _mensajeError = $"Error: {ex.Message}";
        }
    }

    private async Task DeshabilitarCancha(int id)
    {
        try
        {
            var resultado = await CanchasService.DisableCanchaAsync(id);
            if (resultado)
            {
                await CargarCanchas();
            }
            else
            {
                _mensajeError = "Error al deshabilitar la cancha";
            }
        }
        catch (Exception ex)
        {
            _mensajeError = $"Error: {ex.Message}";
        }
    }

    private async Task HabilitarCancha(int id)
    {
        try
        {
            var resultado = await CanchasService.EnableCanchaAsync(id);
            if (resultado)
            {
                await CargarCanchas();
            }
            else
            {
                _mensajeError = "Error al habilitar la cancha";
            }
        }
        catch (Exception ex)
        {
            _mensajeError = $"Error: {ex.Message}";
        }
    }

    private void ConfirmarEliminar(CanchaViewModel cancha)
    {
        _canchaPorEliminar = cancha;
        _mostrarConfirmEliminar = true;
    }

    private void CancelarEliminar()
    {
        _mostrarConfirmEliminar = false;
        _canchaPorEliminar = null;
    }

    private async Task EliminarCancha()
    {
        if (_canchaPorEliminar != null)
        {
            try
            {
                var resultado = await CanchasService.DeleteCanchaAsync(_canchaPorEliminar.Id);
                if (resultado)
                {
                    await CargarCanchas();
                }
                else
                {
                    _mensajeError = "Error al eliminar la cancha";
                }
            }
            catch (Exception ex)
            {
                _mensajeError = $"Error: {ex.Message}";
            }
        }
        CancelarEliminar();
    }

    private void CambiarDia(string dia, bool seleccionado)
    {
        if (seleccionado)
        {
            if (!_formCancha.DiasDisponibles.Contains(dia))
            {
                _formCancha.DiasDisponibles.Add(dia);
            }
        }
        else
        {
            _formCancha.DiasDisponibles.Remove(dia);
        }
    }

    private void CambiarHorario(string hora, bool disponible)
    {
        var horario = _formCancha.HorariosDisponibles.FirstOrDefault(h => h.Hora == hora);
        if (horario != null)
        {
            horario.Disponible = disponible;
        }
    }

    private void CambiarServicio(string servicio, bool seleccionado)
    {
        if (_formCancha.ServiciosAdicionales == null)
        {
            _formCancha.ServiciosAdicionales = new List<string>();
        }

        if (seleccionado)
        {
            if (!_formCancha.ServiciosAdicionales.Contains(servicio))
            {
                _formCancha.ServiciosAdicionales.Add(servicio);
            }
        }
        else
        {
            _formCancha.ServiciosAdicionales.Remove(servicio);
        }
    }

    private void CambiarCaracteristica(string caracteristica, bool seleccionado)
    {
        if (_formCancha.Caracteristicas == null)
        {
            _formCancha.Caracteristicas = new List<string>();
        }

        if (seleccionado)
        {
            if (!_formCancha.Caracteristicas.Contains(caracteristica))
            {
                _formCancha.Caracteristicas.Add(caracteristica);
            }
        }
        else
        {
            _formCancha.Caracteristicas.Remove(caracteristica);
        }
    }

    private async Task CargarImagen(ChangeEventArgs e)
    {
        try
        {
            var files = (IReadOnlyList<IBrowserFile>)e.Value!;
            if (files.Count > 0)
            {
                var file = files[0];
                
                // Validar tamaño (máximo 5MB)
                if (file.Size > 5 * 1024 * 1024)
                {
                    _mensajeError = "La imagen no puede ser mayor a 5MB";
                    return;
                }

                // Validar tipo de archivo
                if (!file.ContentType.StartsWith("image/"))
                {
                    _mensajeError = "Por favor selecciona un archivo de imagen válido";
                    return;
                }

                // Leer el archivo como base64 para preview
                using (var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024))
                {
                    var buffer = new byte[file.Size];
                    await stream.ReadAsync(buffer, 0, (int)file.Size);
                    _imagenPreview = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
                    _formCancha.Imagen = _imagenPreview;
                }
            }
        }
        catch (Exception ex)
        {
            _mensajeError = $"Error al cargar la imagen: {ex.Message}";
        }
    }

    private void AbrirModalCrearDeporte()
    {
        _mostrarModalDeporte = true;
    }

    private void CerrarModalDeporte()
    {
        _mostrarModalDeporte = false;
    }
}
