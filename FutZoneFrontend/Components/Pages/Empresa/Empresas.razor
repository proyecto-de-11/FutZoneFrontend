@page "/propietario/empresas"
@using System.Collections.Generic
@using FutZoneFrontend.Services
@using FutZoneFrontend.Services.Models
@using Microsoft.AspNetCore.Components
@using System.Linq

<PageTitle>Mis Empresas - FutZone</PageTitle>

<!-- Header con T√≠tulo y Bot√≥n de Creaci√≥n -->
<div class="header-empresas p-4 mb-4 text-white rounded-lg shadow-lg">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h1 class="h3 mb-0">üèüÔ∏è Mis Negocios y Sedes</h1>
            <p class="lead mb-0">@(ListaEmpresas.Count) empresas registradas. Administra tu portafolio.</p>
        </div>
        <div class="mt-3 mt-md-0">
            <!-- Bot√≥n de A√±adir Empresa -->
            <a class="btn btn-principal btn-lg shadow-sm" href="/empresa/crear" title="Registrar una nueva sede o negocio">
                <i class="bi bi-plus-circle-fill me-2"></i> A√±adir Nueva Empresa
            </a>
        </div>
    </div>
</div>

@if (IsLoading)
{
    <div class="text-center p-5">
        <div class="spinner-border text-teal" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2 text-teal">Cargando la lista de tus empresas...</p>
    </div>
}
else if (!string.IsNullOrEmpty(ErrorMessage))
{
    <!-- Mensaje de Error de la API -->
    <div class="alert alert-danger text-center mt-5 p-5">
        <h4 class="alert-heading">‚ùå ¬°Error al cargar!</h4>
        <p>@ErrorMessage</p>
        <p class="mb-0">Por favor, revisa la conexi√≥n o int√©ntalo de nuevo m√°s tarde.</p>
    </div>
}
else if (!ListaEmpresas.Any())
{
    <!-- Mensaje si no hay empresas -->
    <div class="alert alert-teal-light text-center mt-5 p-5">
        <h4 class="alert-heading text-principal">üëã ¬°Es hora de empezar!</h4>
        <p>A√∫n no tienes negocios o sedes de canchas registradas.</p>
        <hr>
        <p class="mb-0">Haz clic en **A√±adir Nueva Empresa** para configurar tu primera ubicaci√≥n.</p>
    </div>
}
else
{
    <!-- Lista de Empresas en Formato Tarjeta (Grid) -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        @foreach (var empresa in ListaEmpresas)
        {
            <div class="col">
                <div class="card h-100 shadow-sm border-0 empresa-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h5 class="card-title text-principal">
                                <i class="bi bi-building me-2"></i> @empresa.Nombre
                            </h5>
                            <!-- Se usa un badge est√°tico ya que el estado real no viene en el DTO -->
                            <span class="badge bg-success rounded-pill p-2">
                                Activa
                            </span>
                        </div>
                        <h6 class="card-subtitle mb-2 text-muted small">@empresa.Ubicacion</h6>
                        
                        <p class="card-text small text-truncate mt-3" title="@empresa.Descripcion">
                            Tipo: <strong>@empresa.Tipo</strong> | @empresa.Descripcion
                        </p>
                        
                        <hr />

                        <!-- Placeholder para los campos din√°micos que fueron eliminados de la simulaci√≥n -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-secondary small">Canchas (No disponible)</span>
                            <span class="fw-bold text-muted">--</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <span class="text-secondary small">Ingreso (No disponible)</span>
                            <span class="fw-bold text-muted">--</span>
                        </div>
                        
                        <!-- Bot√≥n para ir al Dashboard de la empresa espec√≠fica -->
                        <a href="/empresa/@empresa.Id/dashboard" class="btn btn-outline-principal w-100 mt-2">
                            Ver Dashboard <i class="bi bi-arrow-right-short"></i>
                        </a>
                        <a href="/empresa/editar/@empresa.Id" class="btn btn-link btn-sm w-100 text-muted mt-2">
                            Editar Detalles
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>
}


@code {
    [Inject] public EmpresaService EmpresaService { get; set; }
    [Inject] public NavigationManager NavigationManager { get; set; }

    // **IMPORTANTE:** Se usa directamente el DTO de la API (EmpresaApiResponse)
    private List<EmpresaApiResponse> ListaEmpresas = new List<EmpresaApiResponse>();
    private bool IsLoading = true;
    private string ErrorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;
        ErrorMessage = string.Empty;
        
        try
        {
            // 2. LLAMADA A LA API
            var apiResponseList = await EmpresaService.ObtenerEmpresasPorUsuarioAsync();

            if (apiResponseList != null)
            {
                // 3. ASIGNACI√ìN DIRECTA de la respuesta de la API al modelo de visualizaci√≥n.
                // **La simulaci√≥n de datos ha sido eliminada.**
                ListaEmpresas = apiResponseList;
            }
        }
        catch (Exception ex)
        {
            // Manejo de error b√°sico
            ErrorMessage = $"Ocurri√≥ un error al cargar las empresas: {ex.Message}. Por favor, verifica la consola para m√°s detalles.";
            Console.WriteLine($"Error de carga de empresas: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }
    
    // El m√©todo GetEstadoBadgeClass ya no es necesario ya que el estado se hardcode√≥ en la vista.
    // Se mantiene el estilo.
}

<!-- Estilos personalizados con la paleta de colores verde azulado -->
<style>
    /* Nueva Paleta de Colores (Basada en la imagen) */
    :root {
        --color-principal: #008080; /* Verde Azulado Oscuro/Teal */
        --color-principal-hover: #006666;
        --color-secundario: #f8f9fa; /* Blanco/Gris Claro para botones secundarios */
        --color-texto-claro: #ffffff;
    }

    /* Estilo del Header: color principal s√≥lido */
    .header-empresas {
        background-color: var(--color-principal) !important;
        border-radius: 12px !important;
    }

    /* Texto principal y spinners */
    .text-principal {
        color: var(--color-principal) !important;
    }
    .text-teal {
        color: var(--color-principal) !important;
    }
    
    /* Bot√≥n Principal (A√±adir Empresa) */
    .btn-principal {
        background-color: var(--color-principal) !important;
        border-color: var(--color-principal) !important;
        color: var(--color-texto-claro) !important;
        font-weight: 600;
    }
    .btn-principal:hover {
        background-color: var(--color-principal-hover) !important;
        border-color: var(--color-principal-hover) !important;
        color: var(--color-texto-claro) !important;
    }

    /* Bot√≥n Outline para Dashboard */
    .btn-outline-principal {
        color: var(--color-principal);
        border-color: var(--color-principal);
    }
    .btn-outline-principal:hover {
        background-color: var(--color-principal);
        color: var(--color-texto-claro);
    }

    /* Estilos de la tarjeta */
    .empresa-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border-radius: 12px !important;
        border: 1px solid rgba(0, 128, 128, 0.1); /* Borde sutil del color principal */
    }
    .empresa-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 128, 128, 0.15) !important;
    }

    /* Estilo para el mensaje de "no hay empresas" */
    .alert-teal-light {
        background-color: rgba(0, 128, 128, 0.05);
        border-color: rgba(0, 128, 128, 0.2);
        color: #333;
        border-radius: 8px;
    }
</style>