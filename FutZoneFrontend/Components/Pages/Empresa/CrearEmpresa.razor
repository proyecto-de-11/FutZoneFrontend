@page "/empresa/crear"

@using FutZoneFrontend.Services.Models
@using FutZoneFrontend.Services
@inject EmpresaService EmpresaService
@inject NavigationManager NavigationManager
// La inyecci贸n de IJSRuntime se mantiene en el bloque

<div class="form-container">
    <div class="header-futzone">
        <h2>Nueva Empresa <span class="emoji"></span></h2>
    </div>

    <EditForm Model="@Empresa" OnValidSubmit="@HandleValidSubmit">
        <DataAnnotationsValidator />

        @if (!string.IsNullOrEmpty(Message))
        {
            <div class="@(IsSuccess ? "alert-success" : "alert-danger")">
                @Message
            </div>
        }

        <div class="form-group">
            <label for="Nombre">Nombre de la Empresa</label>
            <InputText id="Nombre" @bind-Value="Empresa.NombreEmpresa" class="form-control" required />
            <ValidationMessage For="@(() => Empresa.NombreEmpresa)" />
        </div>

        <div class="form-group">
            <label for="Tipo">Tipo (Ej. Software, Deportes, Servicios)</label>
            <InputText id="Tipo" @bind-Value="Empresa.TipoEmpresa" class="form-control" required />
        </div>

        <div class="form-group">
            <label for="Descripcion">Descripci贸n</label>
            <InputTextArea id="Descripcion" @bind-Value="Empresa.DescripcionEmpresa" class="form-control" required />
        </div>

        <div class="form-group-inline">
            <div class="form-group">
                <label for="contactos">Tel茅fono/Contactos</label>
                <InputText id="contactos" @bind-Value="Empresa.Contactos" class="form-control" />
            </div>
            <div class="form-group">
                <label for="Correo">Correo Electr贸nico</label>
                <!-- Usamos el InputText gen茅rico y el ValidationMessage se encarga de la validaci贸n de formato email -->
                <InputText id="Correo" @bind-Value="Empresa.Correo" class="form-control" required type="email"/> 
            </div>
        </div>

        <div class="form-group">
            <label for="imagen">URL del Logo/Imagen</label>
            <InputText id="imagen" @bind-Value="Empresa.ImagenUrl" class="form-control" type="url" />
        </div>

        <div class="form-group">
            <label for="Ubicacion">Ubicaci贸n Seleccionada</label>
            <InputText id="Ubicacion" @bind-Value="Empresa.Ubicacion" class="form-control" required placeholder="Selecciona la ubicaci贸n en el mapa de abajo..." />
        </div>

        <div class="form-group">
            <div id="mapbox-ubicacion" style="width: 100%; height: 400px; border-radius: 8px;"></div>
        </div>

        <!-- Eliminamos los atributos 'name' ya que Blazor no los necesita, reduciendo el riesgo de env铆o nativo. -->
        <input type="hidden" id="clieLatitud" />
        <input type="hidden" id="clieLongitud" />
        <div class="form-group">
            <p id="location-message" class="text-info">Buscando tu ubicaci贸n...</p>
        </div>


        <button type="submit" class="btn-primary-futzone" disabled="@IsLoading">
            @if (IsLoading)
            {
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <span>Guardando...</span>
            }
            else
            {
                <span>Crear Empresa</span>
            }
        </button>
    </EditForm>
</div>

<style>
    #mapbox-ubicacion {
        width: 100%;
        height: 350px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .alert-success { background-color: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 15px; }
    .alert-danger { background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin-bottom: 15px; }
</style>

@code {
    [Inject] private IJSRuntime JSRuntime { get; set; }

    // Objeto para enlazar los datos del formulario
    private EmpresaModel Empresa = new EmpresaModel();
    private bool IsLoading = false;
    private string Message = string.Empty;
    private bool IsSuccess = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Delay(50);
            await JSRuntime.InvokeVoidAsync("initMapbox");
        }
    }

    private async Task HandleValidSubmit()
    {
        IsLoading = true;
        Message = string.Empty;
        IsSuccess = false;

        // ** Importante **: Llenar el UsuarioId aqu铆 (asumiendo que viene de un servicio de autenticaci贸n)
        // Por ahora, lo dejamos en 0 si no se ha llenado antes, pero este valor debe venir del IAuthService.
        if (Empresa.UsuarioId == 0)
        {
             // Podr铆as obtener el ID del usuario actual aqu铆 si el IAuthService tiene un m茅todo sincr贸nico.
             // Ejemplo: Empresa.UsuarioId = await EmpresaService.GetLoggedInUserId();
             // Dejamos que el EmpresaService lo gestione, como est谩 en su implementaci贸n.
        }

        // 2. LLAMAR AL SERVICIO
        var success = await EmpresaService.CrearEmpresaAsync(Empresa);

        if (success)
        {
            IsSuccess = true;
            Message = "隆Empresa creada exitosamente! Redirigiendo...";

            // 3. REDIRECCIN TRAS XITO
            await Task.Delay(2000);
            NavigationManager.NavigateTo("/empresas");
        }
        else
        {
            IsSuccess = false;
            Message = "Error al crear la empresa. Verifica los datos o revisa la consola para ver el error de la API.";
            StateHasChanged(); // Forzar la actualizaci贸n para mostrar el mensaje de error
        }

        IsLoading = false;
        // NO LLAMAMOS a StateHasChanged() si hubo 茅xito porque navegamos.
        // Si fall贸, ya lo llamamos antes para mostrar el mensaje de error.
    }
}