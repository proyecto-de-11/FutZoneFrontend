@page "/empresa/crear"

@using FutZoneFrontend.Services.Models
@using FutZoneFrontend.Services
@inject EmpresaService EmpresaService
@inject NavigationManager NavigationManager

<div class="form-container">
    <div class="header-futzone">
        <h2>Nueva Empresa <span class="emoji"></span></h2>
    </div>

    <EditForm Model="@Empresa" OnValidSubmit="@HandleValidSubmit">
        <DataAnnotationsValidator />

        @if (!string.IsNullOrEmpty(Message))
        {
            <div class="@(IsSuccess ? "alert-success" : "alert-danger")">
                @Message
            </div>
        }

        <div class="form-group">
            <label for="Nombre">Nombre de la Empresa</label>
            <InputText id="Nombre" @bind-Value="Empresa.NombreEmpresa" class="form-control" required />
            <ValidationMessage For="@(() => Empresa.NombreEmpresa)" />
        </div>

        <div class="form-group">
            <label for="Tipo">Tipo (Ej. Software, Deportes, Servicios)</label>
            <InputText id="Tipo" @bind-Value="Empresa.TipoEmpresa" class="form-control" required />
        </div>

        <div class="form-group">
            <label for="Descripcion">Descripci贸n</label>
            <InputTextArea id="Descripcion" @bind-Value="Empresa.DescripcionEmpresa" class="form-control" required />
        </div>

        <div class="form-group-inline">
            <div class="form-group">
                <label for="contactos">Tel茅fono/Contactos</label>
                <InputText id="contactos" @bind-Value="Empresa.Contactos" class="form-control" />
            </div>
            <div class="form-group">
                <label for="Correo">Correo Electr贸nico</label>
                <InputText id="Correo" @bind-Value="Empresa.Correo" class="form-control" required type="email" /> 
                <ValidationMessage For="@(() => Empresa.Correo)" />
            </div>
        </div>

        <div class="form-group">
            <label for="imagen">URL del Logo/Imagen</label>
            <InputText id="imagen" @bind-Value="Empresa.ImagenUrl" class="form-control" type="url" />
            <ValidationMessage For="@(() => Empresa.ImagenUrl)" />
        </div>

        <div class="form-group">
            <label for="Ubicacion">Ubicaci贸n (Editable - Arrastra el marcador o haz click)</label>
            <InputText id="Ubicacion" @bind-Value="Empresa.Ubicacion" class="form-control" required placeholder="Selecciona ubicaci贸n y luego edita el alias si es necesario." />
            <ValidationMessage For="@(() => Empresa.Ubicacion)" />
        </div>

        <div class="form-group">
            <div id="mapbox-ubicacion" style="width: 100%; height: 400px; border-radius: 8px;"></div>
        </div>
        
        <div class="form-group">
            <p id="location-message" class="text-info">Buscando tu ubicaci贸n...</p>
        </div>


        <button type="submit" class="btn-primary-futzone" disabled="@IsLoading">
            @if (IsLoading)
            {
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <span>Guardando...</span>
            }
            else
            {
                <span>Crear Empresa</span>
            }
        </button>
    </EditForm>
</div>

<style>
    /* Estilos (sin cambios) */
    #mapbox-ubicacion {
        width: 100%;
        height: 350px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .alert-success { background-color: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 15px; }
    .alert-danger { background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin-bottom: 15px; }
    
    .form-control {
        background-color: #fff;
        border: 1px solid #ced4da;
        color: #495057;
    }
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .form-group-inline {
        display: flex;
        gap: 20px;
    }
    .form-group-inline .form-group {
        flex: 1;
    }
</style>

@code {
    [Inject] private IJSRuntime JSRuntime { get; set; }

    private EmpresaModel Empresa = new EmpresaModel();
    private bool IsLoading = false;
    private string Message = string.Empty;
    private bool IsSuccess = false;

    private DotNetObjectReference<CrearEmpresa> dotNetRef;

    protected override void OnInitialized()
    {
        dotNetRef = DotNetObjectReference.Create(this);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Delay(50);
            await JSRuntime.InvokeVoidAsync("initMapbox", dotNetRef);
        }
    }

    // CAMBIO CLAVE: Solo se usa el 'alias' para el campo 'Ubicacion'.
    // Los dem谩s par谩metros (lat, lng, direccion) se reciben pero se ignoran en el modelo.
    // M茅todo que puede ser llamado desde JavaScript
[JSInvokable]
public void UpdateLocation(string direccion, string alias, double lat, double lng)
{
    // CAMBIO CLAVE: Usa 'direccion' (la direcci贸n completa) en lugar de 'alias'
    Empresa.Ubicacion = direccion; 

    StateHasChanged();
}
    
    public void Dispose()
    {
        dotNetRef?.Dispose();
    }

    private async Task HandleValidSubmit()
    {
        IsLoading = true;
        Message = string.Empty;
        IsSuccess = false;

        if (Empresa.UsuarioId == 0)
        {
             // La l贸gica para obtener el ID del usuario actual debe ir aqu铆
        }

        var success = await EmpresaService.CrearEmpresaAsync(Empresa);

        if (success)
        {
            IsSuccess = true;
            Message = "隆Empresa creada exitosamente! Redirigiendo...";
            await Task.Delay(2000);
            NavigationManager.NavigateTo("/empresas");
        }
        else
        {
            IsSuccess = false;
            Message = "Error al crear la empresa. Verifica los datos o revisa la consola para ver el error de la API.";
            StateHasChanged();
        }

        IsLoading = false;
    }
}