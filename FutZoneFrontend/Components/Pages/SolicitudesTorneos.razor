@page "/solicitudes-torneos"

<PageTitle>Solicitudes de Torneos - FutbolTime</PageTitle>

<div class="solicitudes-container">
    <!-- Header -->
    <div class="solicitudes-header-torneos">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="mb-0">üèÜ Solicitudes de Torneos a Equipos</h1>
                    <p class="text-muted mb-0">Convoca a equipos para participar en tus torneos</p>
                </div>
                <div class="col-auto">
                    <button class="btn btn-info" @onclick="AbrirModalNuevaSolicitud">
                        <i class="bi bi-plus-circle"></i> Nueva Convocatoria
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros y Tabs -->
    <div class="container-fluid mt-4">
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item">
                <a class="nav-link @(_filtroSeleccionado == "pendiente" ? "active" : "")" 
                    href="javascript:void(0)" @onclick="@((e) => CambiarFiltro("pendiente"))" @onclick:preventDefault>
                    <i class="bi bi-hourglass-split"></i> Pendientes (@_solicitudes.Count(s => s.Estado == "Pendiente"))
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link @(_filtroSeleccionado == "aceptada" ? "active" : "")" 
                    href="javascript:void(0)" @onclick="@((e) => CambiarFiltro("aceptada"))" @onclick:preventDefault>
                    <i class="bi bi-hand-thumbs-up"></i> Aceptadas (@_solicitudes.Count(s => s.Estado == "Aceptada"))
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link @(_filtroSeleccionado == "rechazada" ? "active" : "")" 
                    href="javascript:void(0)" @onclick="@((e) => CambiarFiltro("rechazada"))" @onclick:preventDefault>
                    <i class="bi bi-hand-thumbs-down"></i> Rechazadas (@_solicitudes.Count(s => s.Estado == "Rechazada"))
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link @(_filtroSeleccionado == "todas" ? "active" : "")" 
                    href="javascript:void(0)" @onclick="@((e) => CambiarFiltro("todas"))" @onclick:preventDefault>
                    <i class="bi bi-list"></i> Todas (@_solicitudes.Count())
                </a>
            </li>
        </ul>

        <!-- Lista de Solicitudes -->
        <div class="row">
            @if (!ObtenerSolicitudesFiltradas().Any())
            {
                <div class="col-12">
                    <div class="alert alert-info text-center py-5">
                        <i class="bi bi-info-circle" style="font-size: 2rem;"></i>
                        <p class="mt-3 mb-0">No hay convocatorias en esta categor√≠a</p>
                    </div>
                </div>
            }
            else
            {
                @foreach (var solicitud in ObtenerSolicitudesFiltradas())
                {
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card convocatoria-card h-100 @GetEstadoClass(solicitud.Estado)">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="mb-1">üèÜ @solicitud.NombreTorneo</h5>
                                        <p class="mb-0 text-muted small">para @solicitud.NombreEquipo</p>
                                    </div>
                                    <span class="badge @GetBadgeClass(solicitud.Estado)">@solicitud.Estado</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="info-row mb-2">
                                    <span class="label">Categor√≠a:</span>
                                    <span class="value">@solicitud.Categoria</span>
                                </div>
                                <div class="info-row mb-2">
                                    <span class="label">Cupos:</span>
                                    <span class="value">@solicitud.CuposDisponibles</span>
                                </div>
                                <div class="info-row mb-2">
                                    <span class="label">Fecha de Torneo:</span>
                                    <span class="value">@solicitud.FechaTorneo.ToShortDateString()</span>
                                </div>
                                <div class="info-row mb-3">
                                    <span class="label">Convocatoria:</span>
                                    <span class="value">@solicitud.FechaConvocatoria.ToShortDateString()</span>
                                </div>
                                <p class="text-muted small mb-0">
                                    <strong>Descripci√≥n:</strong> @solicitud.Descripcion
                                </p>
                            </div>
                            <div class="card-footer bg-white">
                                <div class="btn-group w-100" role="group">
                                    @if (solicitud.Estado == "Pendiente")
                                    {
                                        <button type="button" class="btn btn-sm btn-info" @onclick="() => AceptarSolicitud(solicitud)">
                                            <i class="bi bi-check-lg"></i> Aceptar
                                        </button>
                                        <button type="button" class="btn btn-sm btn-warning" @onclick="() => RechazarSolicitud(solicitud)">
                                            <i class="bi bi-x-lg"></i> Rechazar
                                        </button>
                                    }
                                    <button type="button" class="btn btn-sm btn-outline-primary" @onclick="() => VerDetalles(solicitud)">
                                        <i class="bi bi-eye"></i> Ver
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => EliminarSolicitud(solicitud)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

<!-- Modal: Nueva Convocatoria -->
@if (_mostrarModalNueva)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">Nueva Convocatoria a Torneo</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre del Torneo</label>
                        <input type="text" class="form-control" placeholder="Ej. Torneo Nacional 2025" @bind="_formularioSolicitud.NombreTorneo">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Equipo a Convocar</label>
                        <select class="form-select" @bind="_formularioSolicitud.NombreEquipo">
                            <option value="">-- Seleccionar Equipo --</option>
                            <option value="Los Campeones">Los Campeones</option>
                            <option value="Juventud Deportiva">Juventud Deportiva</option>
                            <option value="FC Fuerte">FC Fuerte</option>
                            <option value="Atl√©tico Unido">Atl√©tico Unido</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Categor√≠a</label>
                        <select class="form-select" @bind="_formularioSolicitud.Categoria">
                            <option value="">-- Seleccionar Categor√≠a --</option>
                            <option value="Sub-17">Sub-17</option>
                            <option value="Sub-20">Sub-20</option>
                            <option value="Mayores">Mayores</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Cupos Disponibles</label>
                        <input type="number" class="form-control" placeholder="20" @bind="_formularioSolicitud.CuposDisponibles">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Fecha del Torneo</label>
                        <input type="date" class="form-control" @bind="_formularioSolicitud.FechaTorneo">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripci√≥n</label>
                        <textarea class="form-control" rows="3" placeholder="Detalles del torneo" @bind="_formularioSolicitud.Descripcion"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModal">Cancelar</button>
                    <button type="button" class="btn btn-info" @onclick="GuardarSolicitud">Enviar Convocatoria</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Modal: Detalles -->
@if (_mostrarModalDetalles && _solicitudSeleccionada != null)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles de Convocatoria</h5>
                    <button type="button" class="btn-close" @onclick="CerrarModalDetalles"></button>
                </div>
                <div class="modal-body">
                    <div class="detail-item mb-3">
                        <strong>Torneo:</strong> @_solicitudSeleccionada.NombreTorneo
                    </div>
                    <div class="detail-item mb-3">
                        <strong>Equipo:</strong> @_solicitudSeleccionada.NombreEquipo
                    </div>
                    <div class="detail-item mb-3">
                        <strong>Categor√≠a:</strong> @_solicitudSeleccionada.Categoria
                    </div>
                    <div class="detail-item mb-3">
                        <strong>Cupos:</strong> @_solicitudSeleccionada.CuposDisponibles
                    </div>
                    <div class="detail-item mb-3">
                        <strong>Fecha del Torneo:</strong> @_solicitudSeleccionada.FechaTorneo.ToShortDateString()
                    </div>
                    <div class="detail-item mb-3">
                        <strong>Estado:</strong> <span class="badge @GetBadgeClass(_solicitudSeleccionada.Estado)">@_solicitudSeleccionada.Estado</span>
                    </div>
                    <div class="detail-item mb-3">
                        <strong>Descripci√≥n:</strong>
                        <p>@_solicitudSeleccionada.Descripcion</p>
                    </div>
                    <div class="detail-item">
                        <strong>Fechas:</strong>
                        <p class="mb-0">Convocatoria: @_solicitudSeleccionada.FechaConvocatoria.ToShortDateString()</p>
                        <p>Respuesta: @(_solicitudSeleccionada.FechaRespuesta?.ToShortDateString() ?? "Pendiente")</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalDetalles">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .solicitudes-container {
        min-height: 100vh;
        background-color: #f8f9fa;
    }

    .solicitudes-header-torneos {
        background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        color: white;
        padding: 2rem 0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .solicitudes-header-torneos h1 {
        font-size: 2rem;
        font-weight: 700;
    }

    .nav-tabs .nav-link {
        color: #6b7280;
        border-bottom: 3px solid transparent;
        font-weight: 600;
        cursor: pointer;
    }

    .nav-tabs .nav-link.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
        background-color: transparent;
    }

    .nav-tabs .nav-link:hover {
        color: #3b82f6;
    }

    .convocatoria-card {
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .convocatoria-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .convocatoria-card.pendiente {
        border-left: 4px solid #f59e0b;
    }

    .convocatoria-card.aceptada {
        border-left: 4px solid #3b82f6;
    }

    .convocatoria-card.rechazada {
        border-left: 4px solid #ef4444;
    }

    .convocatoria-card .card-header {
        background-color: #f3f4f6;
        border-bottom: 1px solid #e5e7eb;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
    }

    .info-row .label {
        font-weight: 600;
        color: #374151;
    }

    .info-row .value {
        color: #6b7280;
    }

    .btn-group-vertical .btn {
        border-right: 1px solid #e5e7eb;
    }

    .btn-group-vertical .btn:last-child {
        border-right: none;
    }

    .modal.d-block {
        display: block;
    }

    .detail-item {
        padding: 1rem;
        background-color: #f9fafb;
        border-radius: 0.5rem;
    }
</style>

@code {
    private bool _mostrarModalNueva = false;
    private bool _mostrarModalDetalles = false;
    private string _filtroSeleccionado = "pendiente";
    private SolicitudTorneoDTO? _solicitudSeleccionada;
    private SolicitudTorneoFormularioDTO _formularioSolicitud = new();

    private List<SolicitudTorneoDTO> _solicitudes = new();

    protected override async Task OnInitializedAsync()
    {
        await CargarSolicitudes();
    }

    private Task CargarSolicitudes()
    {
        _solicitudes = new List<SolicitudTorneoDTO>
        {
            new() {
                Id = 1,
                NombreTorneo = "Torneo Nacional 2025",
                NombreEquipo = "Los Campeones",
                Categoria = "Mayores",
                CuposDisponibles = 20,
                Estado = "Pendiente",
                FechaTorneo = DateTime.Now.AddMonths(2),
                FechaConvocatoria = DateTime.Now.AddDays(-5),
                Descripcion = "Gran torneo nacional con equipos de toda la regi√≥n"
            },
            new() {
                Id = 2,
                NombreTorneo = "Copa Libertadores",
                NombreEquipo = "Juventud Deportiva",
                Categoria = "Sub-20",
                CuposDisponibles = 16,
                Estado = "Aceptada",
                FechaTorneo = DateTime.Now.AddMonths(3),
                FechaConvocatoria = DateTime.Now.AddDays(-10),
                FechaRespuesta = DateTime.Now.AddDays(-8),
                Descripcion = "Competencia sudamericana de categor√≠as menores"
            },
            new() {
                Id = 3,
                NombreTorneo = "Campeonato Regional",
                NombreEquipo = "FC Fuerte",
                Categoria = "Sub-17",
                CuposDisponibles = 14,
                Estado = "Aceptada",
                FechaTorneo = DateTime.Now.AddMonths(1),
                FechaConvocatoria = DateTime.Now.AddDays(-15),
                FechaRespuesta = DateTime.Now.AddDays(-12),
                Descripcion = "Competencia regional para categor√≠as juveniles"
            },
            new() {
                Id = 4,
                NombreTorneo = "Torneo Amistoso",
                NombreEquipo = "Atl√©tico Unido",
                Categoria = "Mayores",
                CuposDisponibles = 18,
                Estado = "Rechazada",
                FechaTorneo = DateTime.Now.AddMonths(1),
                FechaConvocatoria = DateTime.Now.AddDays(-20),
                FechaRespuesta = DateTime.Now.AddDays(-18),
                Descripcion = "Torneo amistoso entre equipos locales"
            }
        };
        return Task.CompletedTask;
    }

    private List<SolicitudTorneoDTO> ObtenerSolicitudesFiltradas()
    {
        return _filtroSeleccionado switch
        {
            "pendiente" => _solicitudes.Where(s => s.Estado == "Pendiente").ToList(),
            "aceptada" => _solicitudes.Where(s => s.Estado == "Aceptada").ToList(),
            "rechazada" => _solicitudes.Where(s => s.Estado == "Rechazada").ToList(),
            _ => _solicitudes
        };
    }

    private string GetEstadoClass(string estado) => estado.ToLower() switch
    {
        "pendiente" => "pendiente",
        "aceptada" => "aceptada",
        "rechazada" => "rechazada",
        _ => ""
    };

    private string GetBadgeClass(string estado) => estado switch
    {
        "Pendiente" => "bg-warning",
        "Aceptada" => "bg-info",
        "Rechazada" => "bg-danger",
        _ => "bg-secondary"
    };

    private void CambiarFiltro(string filtro)
    {
        _filtroSeleccionado = filtro;
    }

    private void AbrirModalNuevaSolicitud()
    {
        _formularioSolicitud = new();
        _mostrarModalNueva = true;
    }

    private void CerrarModal()
    {
        _mostrarModalNueva = false;
    }

    private void GuardarSolicitud()
    {
        var nuevaSolicitud = new SolicitudTorneoDTO
        {
            Id = _solicitudes.Max(s => s.Id) + 1,
            NombreTorneo = _formularioSolicitud.NombreTorneo,
            NombreEquipo = _formularioSolicitud.NombreEquipo,
            Categoria = _formularioSolicitud.Categoria,
            CuposDisponibles = _formularioSolicitud.CuposDisponibles,
            Estado = "Pendiente",
            FechaTorneo = _formularioSolicitud.FechaTorneo,
            FechaConvocatoria = DateTime.Now,
            Descripcion = _formularioSolicitud.Descripcion
        };
        _solicitudes.Add(nuevaSolicitud);
        CerrarModal();
    }

    private void AceptarSolicitud(SolicitudTorneoDTO solicitud)
    {
        solicitud.Estado = "Aceptada";
        solicitud.FechaRespuesta = DateTime.Now;
    }

    private void RechazarSolicitud(SolicitudTorneoDTO solicitud)
    {
        solicitud.Estado = "Rechazada";
        solicitud.FechaRespuesta = DateTime.Now;
    }

    private void VerDetalles(SolicitudTorneoDTO solicitud)
    {
        _solicitudSeleccionada = solicitud;
        _mostrarModalDetalles = true;
    }

    private void CerrarModalDetalles()
    {
        _mostrarModalDetalles = false;
        _solicitudSeleccionada = null;
    }

    private void EliminarSolicitud(SolicitudTorneoDTO solicitud)
    {
        _solicitudes.Remove(solicitud);
    }

    public class SolicitudTorneoDTO
    {
        public int Id { get; set; }
        public string NombreTorneo { get; set; } = "";
        public string NombreEquipo { get; set; } = "";
        public string Categoria { get; set; } = "";
        public int CuposDisponibles { get; set; }
        public string Estado { get; set; } = "Pendiente";
        public DateTime FechaTorneo { get; set; }
        public DateTime FechaConvocatoria { get; set; }
        public DateTime? FechaRespuesta { get; set; }
        public string Descripcion { get; set; } = "";
    }

    public class SolicitudTorneoFormularioDTO
    {
        public string NombreTorneo { get; set; } = "";
        public string NombreEquipo { get; set; } = "";
        public string Categoria { get; set; } = "";
        public int CuposDisponibles { get; set; }
        public DateTime FechaTorneo { get; set; }
        public string Descripcion { get; set; } = "";
    }
}
