@page "/admin/usuarios"
@using System.Net.Http
@using System.Net.Http.Json
@inject IHttpClientFactory HttpClientFactory

<PageTitle>Gestión de Usuarios - FutZone Admin</PageTitle>

<div class="container-fluid py-4">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Gestión de Usuarios</h4>
            <button class="btn btn-primary" @onclick="() => _selectedUsuario = null">Crear Usuario</button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Activo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (_usuarios == null)
                        {
                            <tr><td colspan="5" class="text-center py-4 text-muted">Cargando...</td></tr>
                        }
                        else
                        {
                            @foreach (var usuario in _usuarios)
                            {
                                <tr class="align-middle">
                                    <td>@usuario.Id</td>
                                    <td>@usuario.Email</td>
                                    <td>@_roles?.FirstOrDefault(r => r.Id == usuario.IdRol)?.Nombre</td>
                                    <td><span class="badge @(usuario.EstaActivo ? "bg-success" : "bg-secondary")">@(usuario.EstaActivo ? "Sí" : "No")</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => _selectedUsuario = usuario">Editar</button>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="async () => await EliminarUsuario(usuario.Id)">Eliminar</button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    @if (_selectedUsuario != null)
    {
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">@( _selectedUsuario.Id == 0 ? "Crear Nuevo Usuario" : "Editando Usuario")</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" @bind="_selectedUsuario.Email" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Contraseña (dejar en blanco para no cambiar)</label>
                        <input type="password" class="form-control" @bind="_password" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Rol</label>
                        <select class="form-select" @bind="_selectedUsuario.IdRol">
                            @foreach (var rol in _roles!)
                            {
                                <option value="@rol.Id">@rol.Nombre</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-6 mb-3 d-flex align-items-end">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="estaActivo" @bind="_selectedUsuario.EstaActivo" />
                            <label class="form-check-label" for="estaActivo">Está Activo</label>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <button class="btn btn-secondary me-2" @onclick="() => _selectedUsuario = null">Cancelar</button>
                    <button class="btn btn-primary" @onclick="GuardarUsuario">Guardar Cambios</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private HttpClient? _authApiClient;
    private List<Usuario>? _usuarios;
    private List<Rol>? _roles;
    private Usuario? _selectedUsuario;
    private string? _password;

    protected override async Task OnInitializedAsync()
    {
        _authApiClient = HttpClientFactory.CreateClient("Auth");
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        try
        {
            _usuarios = await _authApiClient!.GetFromJsonAsync<List<Usuario>>("usuarios");
            _roles = await _authApiClient!.GetFromJsonAsync<List<Rol>>("roles");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar datos: {ex.Message}");
        }
    }

    private async Task GuardarUsuario()
    {
        if (_selectedUsuario == null) return;

        var url = _selectedUsuario.Id == 0 ? "usuarios" : $"usuarios/{_selectedUsuario.Id}";
        var method = _selectedUsuario.Id == 0 ? HttpMethod.Post : HttpMethod.Put;

        var request = new HttpRequestMessage(method, url)
        {
            Content = JsonContent.Create(new { _selectedUsuario.Email, _selectedUsuario.IdRol, _selectedUsuario.EstaActivo, Password = _password })
        };
        
        var response = await _authApiClient!.SendAsync(request);

        if (response.IsSuccessStatusCode)
        {
            _selectedUsuario = null;
            await CargarDatos();
            StateHasChanged();
        }
    }

    private async Task EliminarUsuario(int usuarioId)
    {
        var response = await _authApiClient!.DeleteAsync($"usuarios/{usuarioId}");
        if (response.IsSuccessStatusCode)
        {
            await CargarDatos();
            StateHasChanged();
        }
    }

    // DTOs
    public class Usuario
    {
        public int Id { get; set; }
        public string Email { get; set; } = string.Empty;
        public int IdRol { get; set; }
        public bool EstaActivo { get; set; }
    }

    public class Rol
    {
        public int Id { get; set; }
        public string Nombre { get; set; } = string.Empty;
    }
}
